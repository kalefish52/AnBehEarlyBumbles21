---
title: "kMeans"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Packages
```{r}
library(tidyverse)
library(plotly)
```

## Load Data
```{r}
# pooled data across timepoints, values are counts
# includes all bees, but only known bees with >=3 observations have shannon values
count_data <- read.csv("../Data/filtData/count_data.csv")
head(count_data)

```

# K Means Cluster Analyses -- determine whether points cluster into two or more groups
Elbow Method for finding the optimal number of clusters. optimal number of clusters = elbow of the graph. (in this case 3)
```{r find number of clusters in k means}
## set seed of random number generator for reproducibility
set.seed(123)

## compute and plot total within sum of squares for 2-10 clusters
k.max <- 10
## make sure the subset of count_data here includes feedsbrood, nectarforage, pollenforage, egglay
data <- count_data[, c("feedsbrood", "nectarforaging", "pollenforaging")]

wss <- sapply(1:k.max, 
              function(k){kmeans(data, k, nstart=50, iter.max = 20)$tot.withinss})
wss
## plot and look to find the elbow. here it is at 3
elbow <- plot(1:k.max, wss,
     type="b", pch = 19, frame = FALSE, 
     xlab="Number of clusters K",
     ylab="Total within-clusters sum of squares")
elbow
```

run k means analysis
```{r}
## set random number generator seed for reproducibility
set.seed(124)

## set k based on where elbow is in above graph
k <- 2

## run k means test
## in this case, columns 4:6 includes broodfeed, nectarforage, pollenforage
test <- kmeans(data, k, nstart = 20)
test
```
 graph k means analysis
```{r} 
## make cluster a factor so we can graph with it
count_data$cluster <- as.factor(test$cluster)
count_data
## graph the data in 3d. color code based on cluster, make queens solid circles and workers open circles. 
## make egg laying workers x 
plot_ly(x = count_data$feedsbrood, 
        y = count_data$pollenforaging, 
        z = count_data$nectarforaging, 
        type="scatter3d", 
        mode="markers",
        symbol = count_data$caste, symbols = c('square', 'circle','o'),
        color = count_data$cluster) %>%
  layout(
    title = "k means clustering",
    scene = list(
      xaxis = list(title = "feedsbrood"),
      yaxis = list(title = "pollenforaging"),
      zaxis = list(title = "nectarforaging"))
  )

#Plot counts of each cluster for each specBehav
kcounts<-count_data %>% select(nestID, beeID, specBehav, cluster)
head(kcounts)

kSUM<-kcounts %>% group_by(specBehav, cluster) %>% mutate(count=1) %>% mutate(frequency=sum(count)) %>% select(specBehav, cluster, frequency) %>% unique()

ggplot(kSUM, aes(x=specBehav, y=frequency, fill=cluster)) +
    geom_bar(stat="identity", position=position_dodge(), colour="black")

```
                     