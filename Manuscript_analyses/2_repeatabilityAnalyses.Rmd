---
title: "Repeatability Analysis"
output: pdf_document
fig.width: 6
fig.height: 15
---
#Need to run after Shannon Bees 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load packages
```{r}
library(tidyverse)
library(plyr)
library(ggplot2)
library(cluster) # clustering algorithms
library(factoextra)
library(vegan) 
library(lme4)
library(plotly)
library(ggpubr)
library(car)
library(MASS)
library(MuMIn)
library(lsmeans)
library(dplyr)
```

# Repeatability measurements and interpretation instructions 
https://cran.r-project.org/web/packages/rptR/vignettes/rptR.html
If 95% confidence intervals of random effect does not reach 0, this suggests that the behavior is repeatable 
Individuals=grouping factor in our case 
R^2 quantifies the proportion of variance explained by fixed effects 
R=0 no variation is explained by the fixed effect 
Adjusted repeatability: controls for fixed effects - any variance that is explained by the fixed effect is excluded from the denominator 

```{r}
library(rptR)
library(dplyr)
```


# load data and filter so that all bees have >= 3 observations
```{r}
rptdata<-read.csv("../Data/filtData/count_time.csv") %>% dplyr::select(nestID, nestTYPE, beeID, caste, timepoint, nectarforaging, feedsbrood, pollenforaging, nBehavs, specBehav)
head(rptdata)

#Make sure all bees have >=3 behavioral observations
rpt_data<-rptdata %>% filter(nBehavs>=3)
print(paste0("We filtered out", nrow(rptdata)-nrow(rpt_data) , " bees that did not have >=3 behaviors, with" , nrow(rpt_data) , "bees used in the final analysis"))
```

# Repeatability Analyses on scaled counts 
## Repeatability brood feeding 
```{r}
hist(rpt_data$feedsbrood) # try gaussian
repfb<- rpt(feedsbrood ~ timepoint+(1|beeID)+(1|nestID),
            grname = c("beeID", "nestID"), data = rpt_data, 
            datatype = "Gaussian", nboot = 1000, npermut = 0)
summary(repfb)
print(repfb)
plot(repfb, cex.main = 1)


#Check model fit - residuals looks ok 
lmfb<-lmer(feedsbrood~timepoint+(1|beeID)+(1|nestID),  
           data=rpt_data)

summary(lmfb)
hist(residuals(lmfb))
plot(fitted(lmfb), residuals(lmfb), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2)
lines(smooth.spline(fitted(lmfb), residuals(lmfb)))

```

## Repeatability nectar foraging
```{r}
repnf<- rpt(nectarforaging ~ timepoint+(1|beeID)+(1|nestID),
            grname = c("beeID", "nestID"), data = rpt_data, 
            datatype = "Gaussian", nboot = 1000, npermut = 0)
summary(repnf)
print(repnf)
plot(repnf, cex.main = 1)

#Check model fit - nectar foraging
lmnf<-lmer(nectarforaging~timepoint+(1|beeID)+(1|nestID),  
           data=rpt_data)

summary(lmnf)
hist(residuals(lmnf))
plot(fitted(lmnf), residuals(lmnf), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2)
lines(smooth.spline(fitted(lmnf), residuals(lmnf)))
head(rpt_data)
```
## Repeatability pollen foraging
```{r}
hist(rpt_data$pollenforaging)
repf<- rpt(pollenforaging ~ timepoint+(1|beeID)+(1|nestID),
            grname = c("beeID", "nestID"), data = rpt_data, 
            datatype = "Gaussian", nboot = 1000, npermut = 0)
summary(repf)
print(repf)
plot(repf, cex.main = 1)


#Check model fit - pollen foraging - these look pretty off 
lmpf<-lmer(pollenforaging~timepoint+(1|beeID)+(1|nestID),  
           data=rpt_data)

summary(lmpf)
hist(residuals(lmpf))
plot(fitted(lmpf), residuals(lmpf), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2)
lines(smooth.spline(fitted(lmpf), residuals(lmpf)))


```


# Plot nest data for rpt proportions
```{r}
read.csv("../Data/filtData/taskShanTime.csv")
head(rpt_data)

rptDist<-rpt_data %>% 
  dplyr::select(timepoint, nestTYPE, beeID, feedsbrood, 
                nectarforaging, pollenforaging) %>% 
  pivot_longer(!c(timepoint, beeID, nestTYPE), names_to="Behavior", values_to="Counts")  

rptDist$nestTYPE <- as.factor(rptDist$nestTYPE)



ggplot(rptDist, aes(Counts, Behavior, shape=timepoint)) +
  geom_point(position = position_jitter(width=0.1, height=0.2), alpha = 0.8, 
             aes(color = nestTYPE)) +
  scale_shape_manual(values = c(17, 25)) +
  stat_summary(fun = mean, geom = "point", size = 5) + 
  labs(x="Scaled Behavioral Observations on a Particular Behavior")
```


# Plot difference in distance between individuals from timepoint one to timepoint two 
```{r}
# add column for Dist
rpttime<-rptDist
rpttime$Dist <- NA
# calculate change in proportion over time and add to Dist column
for (i in 1:nrow(rpttime)) {              # for each row in the dataset
  if(rpttime$timepoint[i] == "late") {                # look at the the late bees only
    for (j in 1:nrow(rpttime)) {                     # then iterate back through the dataset
      if(rpttime$timepoint[j] == "early" & 
         rpttime$beeID[j] == rpttime$beeID[i]
         & rpttime$Behavior[j] == rpttime$Behavior[i]) {   
        # and find the early entry with the same behav
        rpttime$Dist[i] <- rpttime$Counts[i] - rpttime$Counts[j] 
        # calculate the difference across time
      }
    }
  }
}

#Filter out individuals that do not have observations at both timepoints
rpttime<-rpttime[complete.cases(rpttime), ]
rpttime

# plot the change from early to late
avgPropDist <- rpttime %>% dplyr::summarize(avg = mean(Dist, na.rm = T)) %>% dplyr::pull(avg)

rpttime$nestTYPE <- ordered(rpttime$nestTYPE, levels = c("NT", "NF", "QT", "QF"))
R1<-ggplot(rpttime, aes(Dist, Behavior)) +
  geom_point(position = position_jitter(width=0.1, height=0.2), alpha = 0.8, aes(color = nestTYPE)) +
  scale_shape_manual(values = c(17, 25)) +
  stat_summary(fun = mean, geom = "point", size = 5) +
  geom_vline(aes(xintercept = avgPropDist), color = "gray70", size = 0.6) +
  labs(x = "change in individual behavior proportion from early to late timepoint")

ggsave("../figures/rptDistBehav.jpg")
```


```{r}
# Select all beeIDs from rpttime that had a reciprocal timepoint and filter rptDist so both timepoints are in dataframe
beestime<-rpttime %>% dplyr::select(beeID) %>% unique()

namesbeesfilt<-as.list(beestime)
rpt_filt_graph<-rptDist %>% filter(beeID %in% namesbeesfilt$beeID)

rpt_filt_graph$nestTYPE <- ordered(rpt_filt_graph$nestTYPE, levels = c("NT", "NF", "QT", "QF"))
R2<-ggplot(rpt_filt_graph, aes(Counts, Behavior, shape=timepoint)) +
  geom_point(position = position_jitter(width=0.1, height=0.2), alpha = 0.8, 
             aes(color = nestTYPE)) +
  scale_shape_manual(values = c(17, 25)) +
  stat_summary(fun = mean, geom = "point", size = 5) + 
  labs(x="change in number of behaviors performed in a nest")
R2
ggsave("../figures/rptNEST.jpg")

ggarrange(R1, R2, nrow=2, labels=c('A', 'B'))
ggsave("../figures/repeatability.jpg")
```











































