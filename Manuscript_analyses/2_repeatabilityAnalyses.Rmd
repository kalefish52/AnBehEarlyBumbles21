---
title: "Repeatability Analysis"
output: pdf_document
fig.width: 6
fig.height: 15
---
#Need to run after Shannon Bees 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load packages
```{r}
library(tidyverse)
library(plyr)
library(ggplot2)
library(cluster) # clustering algorithms
library(factoextra)
library(vegan) 
library(lme4)
library(plotly)
library(ggpubr)
library(car)
library(MASS)
library(MuMIn)
library(lsmeans)
library(dplyr)
```

# Repeatability measurements and interpretation instructions 
https://cran.r-project.org/web/packages/rptR/vignettes/rptR.html
If 95% confidence intervals of random effect does not reach 0, this suggests that the behavior is repeatable 
Individuals=grouping factor in our case 
R^2 quantifies the proportion of variance explained by fixed effects 
R=0 no variation is explained by the fixed effect 
Adjusted repeatability: controls for fixed effects - any variance that is explained by the fixed effect is excluded from the denominator 

```{r}
library(rptR)
```


# load data
```{r}
rptdata<-read.csv("../Data/filtData/count_time.csv") %>% dplyr::select(nestID, nestTYPE, beeID, caste, timepoint, nectarforaging, feedsbrood, pollenforaging, nBehavs, specBehav)
head(rptdata)

obsdata<-read.csv("../Data/filtData/obs_time.csv")%>% select(camID, nestID, dateID, hourID, timepoint)%>% distinct(camID,  nestID, dateID, hourID, timepoint)


```

#Repeatability analyses for proportions - proportion data type
```{r}
# Add proportion columns 
rpt_prop <- rptdata %>% 
  mutate(propfb=feedsbrood/nBehavs) %>% 
  mutate(propn=nectarforaging/nBehavs) %>% 
  mutate(propp=pollenforaging/nBehavs) %>% 
  mutate(propt=(pollenforaging+nectarforaging)/nBehavs)

# Repeatability proportion brood feeding 
hist(rpt_prop$propfb) # try gaussian
reppfb<- rpt(propfb ~ timepoint+(1|beeID)+(1|nestID),
            grname = c("beeID", "nestID"), data = rpt_prop, 
            datatype = "Gaussian", nboot = 1000, npermut = 0)
summary(reppfb)
print(reppfb)
plot(reppfb, cex.main = 1)

#Check model fit - residuals looks ok 
lmfb<-lmer(propfb~timepoint+(1|beeID)+(1|nestID),  
           data=rpt_prop)

summary(lmfb)
hist(residuals(lmfb))
plot(fitted(lmfb), residuals(lmfb), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2)
lines(smooth.spline(fitted(lmfb), residuals(lmfb)))

#Repeatability proportion nectar foraging
reppnf<- rpt(propn ~ timepoint+(1|beeID)+(1|nestID),
            grname = c("beeID", "nestID"), data = rpt_prop, 
            datatype = "Gaussian", nboot = 1000, npermut = 0)
summary(reppnf)
print(reppnf)
plot(reppnf, cex.main = 1)

#Check model fit - nectar foraging
lmnf<-lmer(propn~timepoint+(1|beeID)+(1|nestID),  
           data=rpt_prop)

summary(lmnf)
hist(residuals(lmnf))
plot(fitted(lmnf), residuals(lmnf), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2)
lines(smooth.spline(fitted(lmnf), residuals(lmnf)))


#Repeatability proportion pollen foraging 
reppf<- rpt(propp ~ timepoint+(1|beeID)+(1|nestID),
            grname = c("beeID", "nestID"), data = rpt_prop, 
            datatype = "Gaussian", nboot = 1000, npermut = 0)
summary(reppf)
print(reppf)
plot(reppf, cex.main = 1)


#Check model fit - pollen foraging - these look pretty off 
lmpf<-lmer(propp~timepoint+(1|beeID)+(1|nestID),  
           data=rpt_prop)

summary(lmpf)
hist(residuals(lmpf))
plot(fitted(lmpf), residuals(lmpf), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2)
lines(smooth.spline(fitted(lmpf), residuals(lmpf)))

head(rpt_prop)
#Repeatability proportion total foraging 
reptf<- rpt(propt ~ timepoint+(1|beeID)+(1|nestID),
            grname = c("beeID", "nestID"), data = rpt_prop, 
            datatype = "Gaussian", nboot = 1000, npermut = 0)
summary(reptf)
print(reptf)
plot(reptf, cex.main = 1)


#Check model fit - pollen foraging - these look pretty off 
lmt<-lmer(propt~timepoint+(1|beeID)+(1|nestID),  
           data=rpt_prop)

summary(lmt)
hist(residuals(lmt))
plot(fitted(lmt), residuals(lmt), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2)
lines(smooth.spline(fitted(lmt), residuals(lmt)))

```



# Scale by amount of nest video observed
```{r}

unfilteredobs<-read.csv("../Data/obs_data.csv")
unfilteredobs %>% filter(nestID=="NF03")
#How many observations (nest and for) did we do for each nest? 
obsdatascale<-obsdata %>% mutate(count=1) %>% group_by(nestID, camID) %>%mutate(obsnum=sum(count)) %>% select(!c(count, dateID, hourID)) %>% unique()
obsdatascale 
obsdata%>% filter(nestID=="QT15")
fors<-obsdatascale %>% filter(camID=="for")
fors
full_join(rptdata, fors, by="nestID") %>% arrange(nestID) %>% select(nestID, beeID, timepoint, camID, obsnum)


#How many observations do we have? (all, early, late)
print(paste("There are", nrow(rptdata), "rows"))
Earlies<-rptdata %>% filter(timepoint=="early") 
print(paste("There are", nrow(Earlies), "early rows"))
Laties<-rptdata%>% filter(timepoint=="late") 
print(paste("There are", nrow(Laties), "late rows"))

```

#Separate specialists and generalists and look at repeatability 
```{r}
nectar <- rptdata %>% filter(specBehav=="generalist")

nectar


```













































