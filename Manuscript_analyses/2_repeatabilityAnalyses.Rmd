---
title: "Repeatability Analysis"
output: pdf_document
fig.width: 6
fig.height: 15
---
#Need to run after Shannon Bees 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=2.5, fig.height=3.5) # use only to create multipanel rptr plot

```

# load packages
```{r}
library(tidyverse)
library(plyr)
library(ggplot2)
library(cluster) # clustering algorithms
library(factoextra)
library(vegan) 
library(lme4)
library(plotly)
library(ggpubr)
library(car)
library(MASS)
library(MuMIn)
library(lsmeans)
library(dplyr)
```

# Repeatability measurements and interpretation instructions 
https://cran.r-project.org/web/packages/rptR/vignettes/rptR.html
If 95% confidence intervals of random effect does not reach 0, this suggests that the behavior is repeatable 
Individuals=grouping factor in our case 
R^2 quantifies the proportion of variance explained by fixed effects 
R=0 no variation is explained by the fixed effect 
Adjusted repeatability: controls for fixed effects - any variance that is explained by the fixed effect is excluded from the denominator 

```{r}
library(rptR)
library(dplyr)
```


# load data and filter so that all bees have >= 3 observations and only include workers
```{r}
rptdata<-read.csv("../Data/filtData/count_time.csv") %>% dplyr::select(nestID, nestTYPE, beeID, caste, timepoint, nectarforaging, feedsbrood, pollenforaging, nBehavs, specBehav, lazy)%>% filter(lazy=="notLazy")


#Filter so that we only include bees that have observations at both timepoints
# add column for Dist
rptworkers<-rptdata %>% filter(caste=="W")

rpttime<-rptworkers %>% 
  dplyr::select(timepoint, nestTYPE, nestID, beeID, feedsbrood, 
                nectarforaging, pollenforaging) %>% 
  pivot_longer(!c(timepoint, beeID, nestTYPE, nestID), names_to="Behavior", values_to="Counts")  

rpttime

rpttime$Dist <- NA
rpttime$propDist <- NA

# calculate change in number of behaviors over time and add to Dist column
for (i in 1:nrow(rpttime)) {              
# for each row in the dataset
  if(rpttime$timepoint[i] == "late") {                
  # look at the the late bees only
    for (j in 1:nrow(rpttime)) {                     
    # then iterate back through the dataset
      if(rpttime$timepoint[j] == "early" & rpttime$beeID[j] == rpttime$beeID[i] & rpttime$Behavior[j] == rpttime$Behavior[i]) {   
      # and find the early entry with the same behav
        rpttime$Dist[i] <- rpttime$Counts[i] - rpttime$Counts[j] 
        # calculate distance
        rpttime$propDist[i] <- (rpttime$Counts[i] - rpttime$Counts[j]) / rpttime$Counts[j]
        # calculate the percent change (late - early) / early
      }
    }
  }
}

rpttime

# Filter out individuals that do not have observations at both timepoints
rpttime<-rpttime[complete.cases(rpttime),]



# Select all beeIDs from rpttime that had a reciprocal timepoint and filter rptDist so both timepoints are in dataframe
beestime<-rpttime %>% dplyr::select(beeID) %>% unique()

namesbeesfilt<-as.list(beestime)
rpt_data<-rptdata %>% filter(beeID %in% namesbeesfilt$beeID)

rpt_data %>% dplyr::select(beeID) %>% unique() %>% nrow()

#pivot longer for graphs :) 
rpt_graphs<-rptworkers %>% pivot_longer(!c(nestID, nestTYPE, beeID, caste, timepoint, specBehav, lazy,  nBehavs), names_to="Behavior", values_to="Counts")
```
### DONT RUN THIS IT TAKES FOREVER 
# Repeatability Analyses on scaled counts 
## Repeatability brood feeding 
```{r}
hist(rptworkers$feedsbrood)
wfb<- rpt(feedsbrood ~ timepoint+(1|beeID)+(1|nestID)+(1|nestTYPE),
            grname = c("beeID", "nestID", "nestTYPE"), data = rptworkers, 
            datatype = "Gaussian", nboot = 1000, npermut = 0)
summary(wfb)
print(wfb)
plot(wfb, cex.main = 1)

#Check model fit - residuals looks ok 
lmfb<-lmer(feedsbrood~timepoint+(1|beeID)+(1|nestID),  
           data=rptworkers)

summary(lmfb)
hist(residuals(lmfb))
plot(fitted(lmfb), residuals(lmfb), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2)
lines(smooth.spline(fitted(lmfb), residuals(lmfb)))
```

## Repeatability nectar foraging
```{r}
hist(rptworkers$nectarforaging)
wnf<- rpt(nectarforaging ~ timepoint+(1|beeID)+(1|nestID)+(1|nestTYPE),
            grname = c("beeID", "nestID", "nestTYPE"), data = rptworkers, 
            datatype = "Gaussian", nboot = 1000, npermut = 0)
summary(wnf)
print(wnf) 
plot(wnf, cex.main = 1)

#Check model fit - nectar foraging
lmnf<-lmer(nectarforaging~timepoint+(1|beeID)+(1|nestID),  
           data=rptworkers)

summary(lmnf)
hist(residuals(lmnf))
plot(fitted(lmnf), residuals(lmnf), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2)
lines(smooth.spline(fitted(lmnf), residuals(lmnf)))
head(rpt_data)

```
## Repeatability pollen foraging
```{r}
hist(rptworkers$pollenforaging)
wf<- rpt(pollenforaging ~ timepoint+(1|beeID)+(1|nestID)+(1|nestTYPE),
            grname = c("beeID", "nestID", "nestTYPE"), data = rptworkers, 
            datatype = "Gaussian", nboot = 1000, npermut = 0)
summary(wf)
print(wf)
plot(wf, cex.main = 1)

#Check model fit - pollen foraging - these look pretty off 
lmpf<-lmer(pollenforaging~timepoint+(1|beeID)+(1|nestID),  
           data=rptworkers)

summary(lmpf)
hist(residuals(lmpf))
plot(fitted(lmpf), residuals(lmpf), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2)
lines(smooth.spline(fitted(lmpf), residuals(lmpf)))
```


# Plot nest data for rpt proportions (only for workers)
```{r}
ggplot(rpt_graphs, aes(Counts, Behavior, shape=timepoint)) +
  geom_point(position = position_jitter(width=0.1, height=0.2), alpha = 0.8, 
             aes(color = nestTYPE)) +
  scale_shape_manual(values = c(17, 25)) +
  stat_summary(fun = mean, geom = "point", size = 5) + 
  labs(x="Scaled Behavioral Observations on a Particular Behavior")

ggsave("../figures/rptnest.jpg")
```


# Plot difference in distance between individuals from timepoint one to timepoint two 
```{r}
# plot the change from early to late
rpttime
#rptworkers

# make inf 18.1 (larger than any others)
# add a new value for graphing infinities separately
rpttime$inf <- "no"
for(i in 1:nrow(rpttime)) {
  if(rpttime$propDist[i] == Inf) {
    rpttime$propDist[i] <- 1
    rpttime$inf[i] <- "yes"
  }
  if(rpttime$propDist[i] == -Inf) {
    rpttime$propDist[i] <- -1
    rpttime$inf[i] <- "yes"
  }
  # make -100% change also be infinity 
  if(rpttime$Counts[i] == 0) {
    rpttime$inf[i] <- "yes"
  }
}
rpttime
rpttime$propDist <- rpttime$propDist * 100

#avgPropDist <- rpttime %>% dplyr::summarize(avg = mean(Dist, na.rm = T)) %>% dplyr::pull(avg)

rpttime$nestTYPE <- ordered(rpttime$nestTYPE, levels = c("NT", "NF", "QT", "QF"))

# recode propDist

R1<-ggplot(rpttime, aes(Dist, Behavior)) +
  geom_point(position = position_jitter(width=2, height=0.3), alpha = 0.7, aes(color = nestTYPE, size = abs(propDist), shape = inf)) +
  scale_shape_manual(values = c(19, 21), labels = c("yes", "no")) +
  #stat_summary(fun = mean, geom = "point", size = 3) +
  geom_vline(aes(xintercept = 0), color = "gray70", size = 0.6) +
  scale_color_manual(values = c("#fdb863", "#e66101", "#b2abd2", "#5e3c99"), labels = c("W3", "W5", "QW3", "QW5")) +
  labs(x = "Change in number of behaviors performed by each individual", y = "Task", 
       size = "Percent change", color = "Social configuration", shape = ">0 observations at both timeframes") +
  scale_y_discrete(labels=c("pollenforaging" = "Pollen\ncollection", "nectarforaging" = "Nectar\ncollection", "feedsbrood" = "Brood\nfeeding")) + 
  theme(legend.position="bottom", legend.box = "vertical") + 
  guides(color = guide_legend(order = 1, override.aes = list(shape = 15, size = 5)),
         size = guide_legend(order=2),
         shape = guide_legend(order = 3))#+
  #stat_summary(fun.data=mean_sdl, fun.args = list(mult=1), 
        #geom="errorbar", width = 0.2) 
R1

# R1<-ggplot(rpttime, aes(Dist, Behavior)) +
#   geom_point(position = position_jitter(width=2, height=0.3), alpha = 0.6, aes(color = nestTYPE)) +
#   scale_shape_manual(values = c(17, 25)) +
#   #stat_summary(fun = mean, geom = "point", size = 3) +
#   geom_vline(aes(xintercept = 0), color = "gray70", size = 0.6) +
#   scale_color_manual(values = c("#fdb863", "#e66101", "#b2abd2", "#5e3c99"), labels = c("W3", "W5", "QW3", "QW5")) +
#   labs(x = "Change in number of behaviors performed by each individual", y = "Task", color = "Social\nConfiguration") +
#   scale_y_discrete(labels=c("pollenforaging" = "Pollen\nCollection", "nectarforaging" = "Nectar\nCollection", "feedsbrood" = "Brood\nFeeding")) #+
#   #stat_summary(fun.data=mean_sdl, fun.args = list(mult=1), 
#         #geom="errorbar", width = 0.2) 
# R1

ggsave("../figures/rptDistBehav.jpg")
```


```{r}
rpt_graphs$nestTYPE <- ordered(rpt_graphs$nestTYPE, levels = c("NT", "NF", "QT", "QF"))
rpttime
rpt_graphs

# summarize by nest
rptnest <- rpttime %>% group_by(Behavior, nestID, nestTYPE) %>% 
  mutate(nestDist=sum(Dist),
         nestCounts=sum(Counts))  %>% 
  dplyr::select(Behavior, nestID, nestTYPE, nestDist, nestCounts) %>% unique()
rptnest
# calculate nestPropDist on summary data
rptnest$nestPropDist <- NA
for(i in 1:nrow(rptnest)) {
  rptnest$nestPropDist[i] <- rptnest$nestDist[i] / (rptnest$nestCounts[i] - rptnest$nestDist[i])
  # dist / (counts-dist) = (late-early) / early
}
rptnest


rptnest$inf <- "no"
for(i in 1:nrow(rptnest)) {
  # make +infinity change infinity
  if(rptnest$nestPropDist[i] == Inf) {
    rptnest$nestPropDist[i] <- 1
    rptnest$inf[i] <- "yes"
  }
  if(rptnest$nestPropDist[i] == -Inf) {
    rptnest$nestPropDist[i] <- -1
    rptnest$inf[i] <- "yes"
  }
  # make -100% change also be infinity 
  if(rptnest$nestCounts[i] == 0) {
    rptnest$inf[i] <- "yes"
  }
}
rptnest$nestPropDist <- rptnest$nestPropDist * 100

# rptnest <- rpttime %>% group_by(Behavior, nestID, nestTYPE) %>%
#   mutate(nestDist=sum(Dist))  %>%
#   dplyr::select(Behavior, nestID, nestTYPE, nestDist) %>% unique()
# 
# rptnest

R2<-ggplot(rptnest, aes(nestDist, Behavior)) +
  geom_point(position = position_jitter(width=2, height=0.3), alpha = 0.7,
             aes(color = nestTYPE, size = abs(nestPropDist), shape = inf)) +
  scale_shape_manual(values = c(19, 21), labels = c("yes", "no")) +
  #stat_summary(fun = mean, geom = "point", size = 3) +
  geom_vline(aes(xintercept = 0), color = "gray70", size = 0.6) +
  scale_color_manual(values = c("#fdb863", "#e66101", "#b2abd2", "#5e3c99"), labels = c("W3", "W5", "QW3", "QW5")) +
  labs(x = "Change in number of behaviors performed by each individual", y = "Task", 
       size = "Percent change", color = "Social configuration", shape = ">0 observations at both timeframes") +
  scale_y_discrete(labels=c("pollenforaging" = "Pollen\ncollection", "nectarforaging" = "Nectar\ncollection", "feedsbrood" = "Brood\nfeeding")) + 
  theme(legend.position="bottom", legend.box = "vertical") + 
  guides(color = guide_legend(order = 1, override.aes = list(shape = 15, size = 5)),
         size = guide_legend(order=2),
         shape = guide_legend(order = 3))#+
R2
ggsave("../figures/rptNEST.jpg")

# R2<-ggplot(rpt_graphs, aes(Counts, Behavior, shape=timepoint)) +
#   geom_point(position = position_jitter(width=2, height=0.3), alpha = 0.8, 
#              aes(color = nestTYPE)) +
#   scale_shape_manual(values = c(17, 25)) +
#   scale_color_manual(values = c("#fdb863", "#e66101", "#b2abd2", "#5e3c99"), labels = c("W3", "W5", "QW3", "QW5")) +
#   stat_summary(fun = mean, geom = "point", size = 4) + 
#   labs(x="Number of Behaviors Performed in Each Nest", y = "Task") +
#   scale_y_discrete(labels=c("pollenforaging" = "Pollen\nCollection", "nectarforaging" = "Nectar\nCollection", "feedsbrood" = "Brood\nFeeding"))
# R2
# ggsave("../figures/rptNEST.jpg")

ggarrange(R1, R2, nrow=2, common.legend = TRUE, legend="bottom", labels=c('A', 'B'))

ggsave("../figures/repeatability.jpg")
```











































