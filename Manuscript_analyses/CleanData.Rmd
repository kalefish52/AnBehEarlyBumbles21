---
title: "CleanData"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
  
### Load Packages
```{r}
library(tidyverse)
library(dplyr)
```





### Load Data
```{r}

## create a list of all the files in the BORISfiles directory. these are all the files we want to import
#borisfiles <- list.files("/Users/ericasarro/Google\ Drive\ File\ Stream/My\ Drive/WoodardLab.shared/Projects/2018.Awesome.Summer.Experiments/Raw\ Data/BORISfiles")

## loop over the files and import all of them. rename column names to remove "." and make shorter
#lapply(borisfiles, read.csv, header = TRUE, col.names = c("obsID", "obsDate", "filename", "totalLen", "fps", "beeID", "behav", "mod", "behavType", "start", "stop", "dur", "comStart", "comStop"))

## do this to all the things 
#do.call(rbind(filename))
```

```{r}
## load a subset of data to test
all_data <- read.csv("/Users/ericasarro/Google\ Drive\ File\ Stream/My\ Drive/MasterProjects/18Su_AwesomeSummer/MockData/AggEvents.csv", header = TRUE, col.names = c("obsID", "obsDate", "filename", "totalLen", "fps", "beeID", "behav", "mod", "behavType", "start", "stop", "dur", "comStart", "comStop" ))
head(all_data)

```





### Clean Data
split obsID column into its component parts to enable manipulation by camera/colony/time/date
```{r}
## convert columns to character to enable manipulation with strsplit() and subset(startsWith())
all_data$beeID <- as.character(all_data$beeID)
all_data$obsID <- as.character(all_data$obsID)

## split out obsID into camID, nestID, dateID and hourID (split based on the tab (\t) between elements)
## element 1 is camID
all_data$camID <- sapply(strsplit(all_data$obsID, "\t"), 
                          function(x){
                            x[1]
                            } )
## element 2 is nestID
all_data$nestID <- sapply(strsplit(all_data$obsID, "\t"), 
                          function(x){
                            x[2]
                            } )
## element 3 is dateID
all_data$dateID <- sapply(strsplit(all_data$obsID, "\t"), 
                          function(x){ 
                            x[3]
                            } )
## element 4 is hourID
all_data$hourID <- sapply(strsplit(all_data$obsID, "\t"), 
                          function(x){ 
                            x[4]
                            } )
```
output df with each bee as a single row, behaviors as columns, count of frequency of each behavior per bee as values
```{r}
## collapse the dataframe to count the number of instances doing each behavior
## this outputs a new dataframe with columns nestID, beeID, nectarforaging, feedsbrood, pollenforaging 
#  (and any other behaviors recorded), with counts for each behavior in as values
## assumes that no two behaviors stopped at the exact same time. cannot handle duplicate stop times. 
#  not sure how to fix that...
count_data <- all_data
count_data$count <- 1
count_data <- count_data %>%
  pivot_wider(id_cols = c("nestID", "beeID", "behav"), 
              names_from = stop, 
              values_from = count)

## add column for sum of counts for each behav
count_data$totCount <- rowSums(count_data[4:ncol(count_data)], na.rm = TRUE)

## subset dataframe so that all is left is nestID, beeID, behav, and totDur
count_data <- count_data %>%
  select(nestID, beeID, behav, totCount)

## collapse dataframe so that each bee has one single row. cols = nestID, beeID, nectarforaging, *other behaviors
count_data <- count_data %>%
  pivot_wider(id_cols = c("nestID", "beeID"), 
              names_from = behav, 
              values_from = totCount)

count_data

```
output df with each bee as a single row, behaviors as columns, total duration of each behavior per bee as values
```{r}
## make duration of all brood feeding events 1 second duration to enable duration comparisons
time_data <- all_data
for (i in 1:nrow(time_data)) {
  if (time_data$behav[i] == "feedsbrood") {
    time_data$dur[i] <- 1
  }
}

## collapse dataframe so that columns = nestID, beeID, behav, and stop times for each behavior. 
## values = duration of each behav
## produces error: Values in `dur` are not uniquely identified; output will contain list-cols. 
#  table showing values as <S3: vctrs_list_of> 
dur_data <- time_data %>%
  pivot_wider(id_cols = c("nestID", "beeID", "behav"), 
              names_from = stop, 
              values_from = dur, 
              names_repair = "minimal")

## add column for sum of duration for each behav
dur_data$totDur <- rowSums(dur_data[4:ncol(dur_data)], na.rm = TRUE)

## subset dataframe so that all is left is nestID, beeID, behav, and totDur
dur_data <- dur_data %>%
  select(nestID, beeID, behav, totDur)

## collapse dataframe so that each bee has one single row. cols = nestID, beeID, nectarforaging, *other behaviors
dur_data <- dur_data %>%
  pivot_wider(id_cols = c("nestID", "beeID"), 
              names_from = behav, 
              values_from = totDur)

dur_data
```
output df with total duration of video watched per colony. columns = nestID and totalLen
```{r}
## select only the obsID, nestID, and totalLen columns
## subset to only the unique combinations (ie. remove duplicates so we don't count more time than we watched)
totalLen_data <- all_data %>%
  select(obsID, nestID, totalLen) %>%
  unique()
totalLen_data

## split out obsID into camID, dateID and hourID (split based on the tab (\t) between elements)
## element 1 is camID
totalLen_data$camID <- sapply(strsplit(totalLen_data$obsID, "\t"), 
                          function(x){
                            x[1]
                            } )
## element 3 is dateID
totalLen_data$dateID <- sapply(strsplit(totalLen_data$obsID, "\t"), 
                          function(x){ 
                            x[3]
                            } )
## element 4 is hourID
totalLen_data$hourID <- sapply(strsplit(totalLen_data$obsID, "\t"), 
                          function(x){ 
                            x[4]
                            } )
## combine date and hour into a single column called timeID
totalLen_data$timeID <- paste(totalLen_data$dateID, totalLen_data$hourID)
## subset the df to remove the obs, hour, and date columns
totalLen_data <- totalLen_data %>%
  select(camID, timeID, nestID, totalLen)

## for each nestID, remove nest videos that have a matching foraging video (i.e. watched twice)
#  sum totalLen for all the for videos + nest videos that do not have a matching for video
camDur <- data.frame(nestID = NA,
                     totalLen = NA)
for (i in 1:length(unique(totalLen_data$nestID))) {
  sub_data <- subset(totalLen_data, nestID == unique(totalLen_data$nestID)[i])
  for_data <- subset(sub_data, sub_data$camID == "for")
  nest_data <- subset(sub_data, sub_data$camID == "nest")
  subNest_data <- nest_data %>%
      filter(! timeID %in% for_data$timeID)
  forSum <- sum(for_data$totalLen)
  nestSum <- sum(subNest_data$totalLen)
  camSum <- forSum + nestSum
  camDur <- rbind(camDur, c(sub_data$nestID[i], camSum))
}
camDur
```







