---
title: "CleanData"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
  
# Load Packages
```{r}
library(tidyverse)
library(dplyr)
library(ggplot2)
```

We have to manually download each project file from Boris. Each project is a single aggregated data file and represents one nest (ex. QF01). To download Boris files into a directory for data cleaning, do the following: 
1) Open project file in BORIS
2) Observations -> Export Events -> Aggregated events
3) Press select all and then ok 
4) Select all subjects then all behaviors, press ok 
5) Group selected events into one file 
6) Save file as nest name eg. "QF01" as a .csv file in the BORISfiles directory 
*Note: all state events must be paired to export as an aggregated file 
*Note: these files do not include observations that did not contain scored behaviors and do not include bees with no observed behaviors 

To download information about all videos watched (including those without any observed behaviors), we have to download an additional file for each project from Boris. To do this:
1) Open project file in BORIS
2) Analysis -> Synthetic time budget
3) Press select all and then ok
4) Press ok
5) Save file as nest name eg. "QF01" as a .csv file in the allBORISfiles directory
6) Click okay without selecting any additional behaviors to subtract from total time

# Load Data
THIS ASSUMES YOUR DEFAULT WORKING DIRECTORY IS WHERE THIS DOCUMENT LIVES (MANUSCRIPT_ANALYSES)
```{r}
## if your wd is not manuscript_analyses, do that here, but comment this out to knit:
#setwd(dirname(rstudioapi::getActiveDocumentContext()$path)) # set it to where this doc lives (Manuscript_analyses)
```
import the BORIS observation datafiles and combine them into a single df called obs_data. this contains all the behavioral observations
```{r}
## function to return list of filenames in BORISfiles folder
  ## use pattern="*.csv", when getting files from google drive stream, there is an extra non-.csv file 
  ## use full.names=TRUE so that it reads in files using absolute file path 
getBORISfilenames <- function(gitfilepath) {
  filenames <- list.files(gitfilepath,
                          pattern = "*.csv",
                          full.names = TRUE)
  return(filenames)
}

## make the list of filenames
BORISfilenames <- getBORISfilenames("../Data/BORISfiles")

## loop over the files in the list and import all of them into a single dataframe. rename column names to remove "." and make shorter
obs_data <- do.call(rbind, lapply(BORISfilenames, 
                                    function(i) {
                                      read.csv(i, header = TRUE,
                                               col.names = c("obsID",
                                                             "obsDate",
                                                             "filename",
                                                             "totalLen",
                                                             "fps",
                                                             "beeID",
                                                             "behav", 
                                                             "cat",
                                                             "mod",
                                                             "behavType",
                                                             "start",
                                                             "stop",
                                                             "dur",
                                                             "comStart",
                                                             "comStop"))
                     }
))

obs_data
init_obs <- nrow(obs_data)
print(paste("There are", init_obs, "observations in the initial obs_data dataframe.", sep = " "))

```

import BORIS synthetic time budget datasheets and merge them into a single dataframe called videos_data
```{r}
## function to return list of filenames in BORISfiles folder
  ## use pattern="*.csv", when getting files from google drive stream, there is an extra non-.csv file 
  ## use full.names=TRUE so that it reads in files using absolute file path 
getBORISfilenames <- function(gitfilepath) {
  filenames <- list.files(gitfilepath,
                          pattern = "*.csv",
                          full.names = TRUE)
  return(filenames)
}

## make the list of filenames
BORISfilenames <- getBORISfilenames("../Data/allBORISfiles")
BORISfilenames
## loop over the files in the list and import all of them into a single dataframe. skip first 3 lines of column headers and only import first 2 columns (obsID and totLen)
videos_data <- do.call(rbind, lapply(BORISfilenames, 
                                    function(i) {
                                      read.csv(i, skip = 3, header = FALSE)[,1:2]
                     }
))

## rename column headers to be descriptive
names(videos_data)[1] <- "obsID"
names(videos_data)[2] <- "totalLen"

videos_data
init_videos <- nrow(videos_data)
print(paste("There are", init_videos, "observations in the initial videos_data dataframe.", sep = " "))

```

import the master datasheets and combine them into a single df called master_dat. this contains beeIDs and natal colony for each nest. this will enable us to include the bees that we did not have observed behaviors for in our analyses
```{r}
## do the same for the master datasheets that contain bee ID numbers
getMasterfilenames <- function(gitfilepath) {
  filenames <- list.files(gitfilepath,
                          pattern = "*.csv",
                          full.names = TRUE)
  return(filenames)
}

## make the list of filenames
masterfilenames <- getMasterfilenames("../Data/MasterDatasheets")

## loop over the files and import all of them. rename column names to remove "." and make shorter
master_data <- do.call(rbind, lapply(masterfilenames, 
                                    function(i) {
                                      read.csv(i, 
                                               header = FALSE, 
                                               skip = 1,
                                               na.strings=c("", " ", "NA", "na", "x", "X", "xp", "-", "#VALUE!", "Died", "died"),
                                               col.names = c("nestID",
                                                             "Qnatal",
                                                             "Qpulled",
                                                             "QID",
                                                             "Gas1",
                                                             "Gas2",
                                                             "Wnatal", 
                                                             "Wpulled",
                                                             "WID1",
                                                             "WID2",
                                                             "WID3",
                                                             "WID4",
                                                             "WID5",
                                                             "Eggs",
                                                             "DaysToEggs",
                                                             "LarvDate",
                                                             "FreezeDate",
                                                             "EggsToEclosion",
                                                             "TotalNestTime",
                                                             "Video1",
                                                             "Video2",
                                                             "Notes",
                                                             "MadeBorisFile"))
                     }
))

master_data
init_master <- nrow(master_data)

print(paste("There are", init_master, "bees accounted for in the initial master_data dataframe.", sep = " "))
```


# Clean Data
split obsID column from obs_data and videos_data into its component parts to enable manipulation by camera/colony/time/date
```{r}
## convert columns to character to enable manipulation with strsplit() and subset(startsWith())
obs_data$beeID <- as.character(obs_data$beeID)
obs_data$obsID <- as.character(obs_data$obsID)
videos_data$obsID <- as.character(videos_data$obsID)

## edit incorrect obsID information and remove QA groups
## remove Kate from front of obsID name
obs_data[obs_data$obsID == "Kate\tfor\tNF02\t20180703\t13", 1] <- "for\tNF02\t20180703\t13"
videos_data[videos_data$obsID == "Kate\tfor\tNF02\t20180703\t13", 1] <- "for\tNF02\t20180703\t13"
## remove space in front of for in one obsID and nest in another
obs_data[startsWith(obs_data$obsID, " for"), 1] <- substring(obs_data[startsWith(obs_data$obsID, " for"), 1], 2, str_length(x))
videos_data[startsWith(videos_data$obsID, " for"), 1] <- substring(videos_data[startsWith(videos_data$obsID, " for"), 1], 2, str_length(x))
obs_data[startsWith(obs_data$obsID, " nest"), 1] <- substring(obs_data[startsWith(obs_data$obsID, " nest"), 1], 2, str_length(x))
videos_data[startsWith(videos_data$obsID, " nest"), 1] <- substring(videos_data[startsWith(videos_data$obsID, " nest"), 1], 2, str_length(x))
## add non to beginning of obsID that are missing for or nest
for (i in 1:nrow(obs_data)){
  if (startsWith(obs_data$obsID[i], "for") | startsWith(obs_data$obsID[i], "nest")) {}
  else {
    obs_data$obsID[i] <- paste("non", obs_data$obsID[i], sep = "\t")
    }
}
for (i in 1:nrow(videos_data)){
  if (startsWith(videos_data$obsID[i], "for") | startsWith(videos_data$obsID[i], "nest")) {}
  else {
    videos_data$obsID[i] <- paste("non", videos_data$obsID[i], sep = "\t")
    }
}
## make nestID character to enable startsWith
obs_data$nestID <- as.character(obs_data$obsID)
videos_data$nestID <- as.character(videos_data$obsID)
master_data$nestID <- as.character(master_data$nestID)
## remove QA groups and bees
obs_data <- obs_data[!startsWith(obs_data$obsID, "QA"),]
videos_data <- videos_data[!startsWith(videos_data$obsID, "QA"),]
master_data <- master_data[!startsWith(master_data$nestID, "QA"),]

## split out obsID into camID, nestID, dateID and hourID (split based on the tab (\t) between elements)
## element 1 is camID
obs_data$camID <- sapply(strsplit(obs_data$obsID, "\t"), 
                          function(x){
                            x[1]
                            } )
videos_data$camID <- sapply(strsplit(videos_data$obsID, "\t"), 
                          function(x){
                            x[1]
                            } )
## element 2 is nestID
obs_data$nestID <- sapply(strsplit(obs_data$obsID, "\t"), 
                          function(x){
                            x[2]
                            } )
videos_data$nestID <- sapply(strsplit(videos_data$obsID, "\t"), 
                          function(x){
                            x[2]
                            } )
## element 3 is dateID
obs_data$dateID <- sapply(strsplit(obs_data$obsID, "\t"), 
                          function(x){ 
                            x[3]
                            } )
videos_data$dateID <- sapply(strsplit(videos_data$obsID, "\t"), 
                          function(x){ 
                            x[3]
                            } )
## element 4 is hourID
obs_data$hourID <- sapply(strsplit(obs_data$obsID, "\t"), 
                          function(x){ 
                            x[4]
                            } )
videos_data$hourID <- sapply(strsplit(videos_data$obsID, "\t"), 
                          function(x){ 
                            x[4]
                            } )


clean_obs <- nrow(obs_data)
clean_videos <- nrow(videos_data)
print(paste("There are", clean_obs, "out of", init_obs, "remaining observations in the cleaned obs_data", sep = " "))
print(paste("There are", clean_videos, "out of", init_videos, "remaining observations in cleaned videos_data", sep = " "))
```

Remove foraging events less than 10 seconds long and remove nest video data after first 5 minutes
```{r}
## remove all nectar foraging events under 10 seconds long
beforeNectRemov <- nrow(obs_data)
obs_data <- obs_data[!(obs_data$behav == "nectarforaging" & obs_data$dur < 10),]
## remove all pollen foraging events under 10 seconds long
beforePollRemov <- nrow(obs_data)
obs_data <- obs_data[!(obs_data$behav == "pollenforaging" & obs_data$dur < 10),]

## print how many were removed that were under 10 seconds long
NectPollRemov <- nrow(obs_data)
print(paste(beforeNectRemov - beforePollRemov, "nectar foraging observations were removed because they were under 10 seconds long.", sep = " "))
print(paste(beforePollRemov - NectPollRemov, "pollen foraging observations were removed because they were under 10 seconds long.", sep = " "))

## cut out all but the first five minutes of nest videos
## make time variables numeric
obs_data$start <- as.numeric(obs_data$start)
obs_data$stop <- as.numeric(obs_data$stop)
obs_data$totalLen <- as.numeric(obs_data$totalLen)
videos_data$totalLen <- as.numeric(videos_data$totalLen)
## remove nest behaviors that start after 5 minute mark
obs_data <- obs_data[!(obs_data$camID == "nest" & obs_data$start > 300),]
## print how many were removed that started after 5 minutes
fiveMinRemov_obs <- nrow(obs_data)
print(paste(NectPollRemov_obs - fiveMinRemov_obs, "observations were removed because they started after the five minute mark.", sep = " "))

## cut down nest videos to only look at first 5 minutes (300 seconds), and make all behaviors stop by 5 minutes
for (i in 1:nrow(obs_data)) {                                             # for every row in the dataframe
  if ((obs_data$camID[i] == "nest") & (obs_data$totalLen[i] > 300)) {     # if it's a nest video and it is over 300 seconds long
    obs_data$totalLen[i] <- 300                                           # make the total length of the video 300 seconds (5 minutes)
    if (obs_data$stop[i] > 300) {                                         # of those nest videos, if a behavior ends past 300 seconds
      obs_data$stop[i] <- 300                                             # set the stop time to 300 seconds
      obs_data$dur[i] <- obs_data$stop[i] - obs_data$start[i]             # and recalculate the duration of that behavior to end at 300s
    }
  }
}

for (i in 1:nrow(videos_data)) {                                             # for every row in the dataframe
  if ((videos_data$camID[i] == "nest") & (videos_data$totalLen[i] > 300)) {  # if it's a nest video and it is over 300 seconds long
    videos_data$totalLen[i] <- 300                                           # make the total length of the video 300 seconds (5 minutes)
  }
}

## make duration of all brood feeding events 1 second duration to enable duration comparisons
for (i in 1:nrow(obs_data)) {
  if (!is.na(obs_data$behav[i]) && obs_data$behav[i] == "feedsbrood") {
    obs_data$dur[i] <- 1
  }
}

head(obs_data)
obs_data

clean_obs <- nrow(obs_data)
clean_videos <- nrow(videos_data)
print(paste("There are now", clean_obs, "observations remaining in the fully cleaned obs_data.", init_obs - clean_obs, "observations fewer than the initial observations, because", beforeNectRemov - beforePollRemov + beforePollRemov - NectPollRemov + NectPollRemov_obs - fiveMinRemov_obs, "were removed above.",  sep = " "))
print(paste("There are now", clean_videos, "out of", init_videos, "remaining videos in fully cleaned videos_data", sep = " "))
```

### look at how many observations we have for each nest for each BORIS download
These files are updated as more video observations are done. Video observations are performed by many different observers. Check how many videos have been observed for each project for foraging and nest, at the two different time points. 
```{r}

## Make a new column for nest type ie. NT or QT etc.
Queencharacter<-sapply(strsplit(obs_data$nestID, ""), 
                          function(x){
                            x[1]
                          })
Numbercharacter<-sapply(strsplit(obs_data$nestID, ""),
                        function(x){
                          x[2]
                        })    
                          
obs_data$nestTYPE<-paste0(Queencharacter, Numbercharacter)

data_sum<- obs_data %>% select(camID, nestID, nestTYPE) %>% arrange(nestID, camID)

sumsTOTAL<-datasum %>% group_by(nestID, camID) %>% summarise(Observations=n())
sumsTYPE<-datasum %>% group_by(nestTYPE, camID) %>% summarise(Observations=n())

##look at number of observations we have so far based on each colony 
ggplot(sumsTOTAL, aes(x=nestID, y=Observations, fill=camID)) +
  geom_bar(stat="identity")+theme(axis.text.x=element_text(angle=90))

## look at number of observations we have so far based on each type of colony 
ggplot(sumsTYPE, aes(x=nestTYPE, y=Observations, fill=camID)) +
  geom_bar(stat="identity")+theme(axis.text.x=element_text(angle=90))


sumsTYPE
sumsTOTAL
```

### combine master_data and obs_data
merge obs_data to master_data to add bees who did not carry out any recorded behaviors (ie missing from obs_data file)
```{r}
## subset master_data to only include nests in the obs_data file
master_data <- subset(master_data, nestID %in% obs_data$nestID)

## make a list of all the bees we do have records for
## select only relevant information
recordedBees <- select(obs_data, nestID, beeID)
## remove duplicates
recordedBees <- unique(recordedBees[c("nestID", "beeID")])
## pull out ID number from beeID column
recordedBees$IDnum <- sapply(strsplit(recordedBees$beeID, ")"),
                        function(x){
                          x[1]
                        })
recordedBees$IDnum <- sapply(strsplit(recordedBees$IDnum, "\\("),
                        function(x){
                          x[2]
                        })
## remove NA values
recordedBees <- recordedBees[!is.na(recordedBees$IDnum),]
## combine nestID and IDnum into one variable because some beeIDs are duplicated across nests
recordedBees$ID <- paste(recordedBees$nestID, recordedBees$IDnum)
## list only IDs
recordedBees <- select(recordedBees, ID)
## print how many bees have behaviors recorded
print(paste("There are", nrow(recordedBees), "bees for which we have recorded behaviors.", sep = " "))
recordedBees

## format the master_data in the same way as the obs_data
## gather the master_data so each worker and queen has their own row
masterBees <- master_data %>%
  gather(QID, WID1, WID2, WID3, WID4, WID5, 
         key = "IDtype", 
         value = "IDnum")
## remove NA values
masterBees <- masterBees[!is.na(masterBees$IDnum),]
## combine nestID and IDnum into one variable because some beeIDs are duplicated across nests
masterBees$ID <- paste(masterBees$nestID, masterBees$IDnum)
## list only IDs
masterBees <- select(masterBees, ID)
## print how many total bees we have
print(paste("There are", nrow(masterBees), "total bees across all colonies in the master datasheet.", sep = " "))
masterBees

## subset masterBees to only include those not recorded
missingBees <- subset(masterBees, !(ID %in% recordedBees$ID))

## split back out nestID and beeID
missingBees$nestID <- sapply(strsplit(missingBees$ID, " "),
                        function(x){
                          x[1]
                        })
missingBees$beeID <- sapply(strsplit(missingBees$ID, " "),
                        function(x){
                          x[2]
                        })
## print how many bees we don't have records for
print(paste("There are", nrow(missingBees), "bees for which we do not have any recorded behaviors.", sep = " "))
missingBees  

## add missing bees to obs_data file
## add rows to obs_data, filled with NA values, number of rows equal to number of missingBees
emptydf <- data.frame(matrix(NA, nrow = nrow(missingBees), ncol = ncol(obs_data)))
## make column names the same
names(emptydf) <- names(obs_data)
## rbind the data. emptydf is at the tail of obs_data
obs_data <- rbind(obs_data, emptydf)  
## fill the empty rows just added to obs_data with the missing bee nestID and beeID
for (i in 0:(nrow(missingBees) - 1)) {
  obs_data$nestID[nrow(obs_data) - i] <- missingBees$nestID[i+1]
  obs_data$beeID[nrow(obs_data) - i] <- missingBees$beeID[i+1]
}

## add random number column to make table compatible with pivot_wider in future steps. needs a unique identifier for each individual
obs_data$rand <- NA
for (i in 1:(nrow(obs_data))) {
  obs_data$rand[i] <- runif(1)
}

## make NA values equal to 0
obs_data[is.na(obs_data)] <- 0

## check how many bees we have in the new obs_data. this is copied and pasted from the methods above. should equal the number of bees in the master_data
## select only relevant information
allBees <- select(obs_data, nestID, beeID)
## remove duplicates
allBees <- unique(allBees[c("nestID", "beeID")])
## pull out ID number from beeID column
allBees$IDnum <- sapply(strsplit(allBees$beeID, ")"),
                        function(x){
                          x[1]
                        })
allBees$IDnum <- sapply(strsplit(allBees$IDnum, "\\("),
                        function(x){
                          x[2]
                        })
## remove NA values
allBees <- allBees[!is.na(allBees$IDnum),]
## combine nestID and IDnum into one variable because some beeIDs are duplicated across nests
allBees$ID <- paste(allBees$nestID, allBees$IDnum)
## list only IDs
allBees <- select(allBees, ID)
## print how many bees have behaviors recorded
print(paste("There are", nrow(allBees), "bees total to be included in the analyses.", sep = " "))
if (nrow(allBees)==nrow(masterBees)) {
  print("All bees from the master datasheets are accounted for!")
} else {
  print(paste("All bees are not properly accounted for. There are", nrow(allBees), "bees accounted for, but the master datasheet has", nrow(masterBees), "bees", sep = " "))
}
allBees

```
### make count data df with counts of each behavior observed for each bee
output df with each bee as a single row, behaviors as columns, count of frequency of each behavior per bee as values
```{r}
## collapse the dataframe to count the number of instances doing each behavior
  ## this outputs a new dataframe with columns nestID, beeID, nectarforaging, feedsbrood, pollenforaging 
  ## (and any other behaviors recorded), with counts for each behavior in as values
  ## assumes rand number is not duplicated across individuals. 

## rename to count_data for clarity 
count_data <- obs_data
## add a column with value 1 that counts the behavioral observations this makes each behavior a count of 1 
count_data$count <- 1  
## condense data frame into relevant columns, each row is a single observation for an individual
count_data <- count_data %>%
  pivot_wider(id_cols = c("nestID", "beeID", "behav"), 
              names_from = rand, 
              values_from = count) 

## add column to fill with sum of counts for each behav
count_data$totCount <- rowSums(count_data[4:ncol(count_data)], na.rm = TRUE)

## subset dataframe so that all is left is nestID, beeID, behav, and totCount
count_data <- count_data %>%
  select(nestID, beeID, behav, totCount)

## collapse dataframe so that each bee has one single row. cols = nestID, beeID, nectarforaging, *other behaviors
count_data <- count_data %>%
  pivot_wider(id_cols = c("nestID", "beeID"), 
              names_from = behav, 
              values_from = totCount)

## replace NA values with 0
count_data[is.na(count_data)] <- 0

## sum rows excluding first two (nestID and beeID) to see total number of behaviors carried out by each indiv
count_data$nBehavs <- rowSums(count_data[, 3:ncol(count_data)], na.rm = TRUE)

## add column for queen / worker status based on first letter in beeID
beeTypeCharacter <- sapply(strsplit(count_data$beeID, ""), 
                          function(x){
                            x[1]
                          })

count_data$beeType <- beeTypeCharacter

## print how many bees we have here. should equal masterdata
print(paste("There are", nrow(count_data), "bees accounted for."))
if (nrow(count_data)==nrow(masterBees)) {
  print("All bees from the master datasheets are accounted for!")
} else {
  print(paste("All bees are not properly accounted for. There are", nrow(count_data), "bees accounted for, but the master datasheet has", nrow(masterBees), "bees", sep = " "))
}
knownWorkers <- nrow(count_data)

## remove unknown worker data
count_data <- count_data[!count_data$beeType == "U", ]
count_data <- count_data[!count_data$beeType == "N", ]
## make missingBees beeType NA
for (i in 1:nrow(count_data)) {
  if (count_data$beeType[i] == 1 || 
      count_data$beeType[i] == 2 || 
      count_data$beeType[i] == 3 ||
      count_data$beeType[i] == 4 ||
      count_data$beeType[i] == 5 ||
      count_data$beeType[i] == 6 ||
      count_data$beeType[i] == 7 ||
      count_data$beeType[i] == 8 ||
      count_data$beeType[i] == 9) {
    count_data$beeType[i] <- 0
  }
}
## print how many unknown workers were removed
print(paste("There were", knownWorkers - nrow(count_data), "unknown workers removed from the dataset.", sep = " "))
 
##Save dataframe as .csv so it can be used in other downstream analyses 
write.csv(count_data, "count_data.csv")

count_data

##graph the number of behaviors we have per nest
Queencharacter <- sapply(strsplit(count_data$nestID, ""), 
                          function(x){
                            x[1]
                          })
Numbercharacter<-sapply(strsplit(count_data$nestID, ""),
                        function(x){
                          x[2]
                        })    
                          
count_data$nestTYPE<-paste0(Queencharacter, Numbercharacter)

data_sum <- count_data %>% select(nestID, nestTYPE, nectarforaging, pollenforaging, feedsbrood, fillshoneypot, laysegg) %>% arrange(nestID)

sumsTYPE<-data_sum %>% group_by(nestTYPE) 

##look at data we have so far based on each colony 

ggplot(data_sum, aes(x=nestID, y=feedsbrood, fill=nestTYPE)) +
  geom_bar(stat="identity")+theme(axis.text.x=element_text(angle=90))

ggplot(data_sum, aes(x=nestID, y=nectarforaging, fill=nestTYPE)) +
  geom_bar(stat="identity")+theme(axis.text.x=element_text(angle=90))

ggplot(data_sum, aes(x=nestID, y=pollenforaging, fill=nestTYPE)) +
  geom_bar(stat="identity")+theme(axis.text.x=element_text(angle=90))

## look at data we have so far based on each type of colony 
ggplot(sumsTYPE, aes(x=nestTYPE, y=feedsbrood, fill=nestTYPE)) +
  geom_bar(stat="identity")+theme(axis.text.x=element_text(angle=90))

ggplot(sumsTYPE, aes(x=nestTYPE, y=nectarforaging, fill=nestTYPE)) +
  geom_bar(stat="identity")+theme(axis.text.x=element_text(angle=90))

ggplot(sumsTYPE, aes(x=nestTYPE, y=pollenforaging, fill=nestTYPE)) +
  geom_bar(stat="identity")+theme(axis.text.x=element_text(angle=90))


```

### make duration df with duration of each behavior for each bee
output df with each bee as a single row, behaviors as columns, total duration of each behavior per bee as values
```{r}
## rename for clarity
dur_data <- obs_data


## only look at first 5 minutes of the watched video to standardize. we only ever watched 5 minutes of nest videos, 
  ## so remove anything over 5 minutes of foraging video to standardize the amount of video watched in each category

## only look at first 5 minutes (300 seconds) of the watched video to standardize
# dur_data$start <- as.numeric(dur_data$start)
# dur_data$stop <- as.numeric(dur_data$stop)
# dur_data <- dur_data[dur_data$start <= 300, ]
# ## make behaviors stop at the end of 5 minutes
# for (i in 1:(nrow(dur_data))) {
#   if (dur_data$stop[i] > 300) {
#     dur_data$stop[i] <- 301
#   }
# }
# 
# ## recalculate duration data to account for stop time at 5 minutes
# for (i in 1:nrow(dur_data)) {
#   dur_data$dur[i] <- dur_data$stop[i] - dur_data$start[i]
# }

## make duration of all brood feeding events 1 second duration to enable duration comparisons
for (i in 1:nrow(dur_data)) {
  if (!is.na(dur_data$behav[i]) && dur_data$behav[i] == "feedsbrood") {
    dur_data$dur[i] <- 1
  }
}

## collapse dataframe so that columns = nestID, beeID, behav, and stop times for each behavior. 
## values = duration of each behav
dur_data <- dur_data %>%
  pivot_wider(id_cols = c("nestID", "beeID", "behav"), 
              names_from = rand, 
              values_from = dur, 
              names_repair = "minimal")

## add column with the sum of durations for each behav
dur_data$totDur <- rowSums(dur_data[4:ncol(dur_data)], na.rm = TRUE)

## subset dataframe so that all is left is nestID, beeID, behav, and totDur
dur_data <- dur_data %>%
  select(nestID, beeID, behav, totDur)

## collapse dataframe so that each bee has one single row. cols = nestID, beeID, nectarforaging, *other behaviors
dur_data <- dur_data %>%
  pivot_wider(id_cols = c("nestID", "beeID"), 
              names_from = behav, 
              values_from = totDur)

## replace NA values with 0
dur_data[is.na(dur_data)] <- 0

##save dataframe as .csv so it can be used in other downstream analyses 
write.csv(dur_data, "dur_data.csv")

## count the number of bees with behaviors
print(paste("There are", nrow(dur_data), "bees accounted for in the duration data."))
if (nrow(dur_data)==nrow(recordedBees)) {
  print("All bees with recorded behaviors are accounted for!")
} else {
  print(paste("All bees are not properly accounted for. There are", nrow(dur_data), "bees accounted for in the duration dataframe, but the boris data has", nrow(recordedBees), "bees with recorded behaviors.", sep = " "))
}

dur_data
```

### duration of video watched for each colony
output df with total duration of video watched per colony. columns = nestID and totalLen
**this currently does not include videos with 0 observations, so it is a vast underestimate of the videos we've watched
```{r}
## select only the obsID, nestID, and totalLen columns
## subset to only the unique combinations (ie. remove duplicate videos so we don't count more time than we watched)
nVids <- nrow(videos_data)
totalLen_data <- videos_data %>%
  select(obsID, nestID, totalLen) %>%
  unique()
totalLen_data
## print how many videos were removed
print(paste("There were", nVids - nrow(totalLen_data), "duplicate videos removed.", sep = " "))

## split out obsID into camID, dateID and hourID (split based on the tab (\t) between elements)
## element 1 is camID
totalLen_data$camID <- sapply(strsplit(totalLen_data$obsID, "\t"), 
                          function(x){
                            x[1]
                            } )
## element 3 is dateID
totalLen_data$dateID <- sapply(strsplit(totalLen_data$obsID, "\t"), 
                          function(x){ 
                            x[3]
                            } )
## element 4 is hourID
totalLen_data$hourID <- sapply(strsplit(totalLen_data$obsID, "\t"), 
                          function(x){ 
                            x[4]
                            } )
## combine date and hour into a single column called timeID
totalLen_data$timeID <- paste(totalLen_data$dateID, totalLen_data$hourID)
## subset the df to remove the obs, hour, and date columns
totalLen_data <- totalLen_data %>%
  select(camID, timeID, nestID, totalLen)

totalLen_data
## verify we have the correct number of colonies and videos
print(paste("There are", nrow(totalLen_data), "videos out of", clean_videos, "fully cleaned videos accounted for in the totalLen_data dataframe."))






# ## Make a new column for nest type ie. NT or QT 
# Queencharacter<-sapply(strsplit(totalLen_data$nestID, ""), 
#                           function(x){
#                             x[1]
#                           })
# Numbercharacter<-sapply(strsplit(totalLen_data$nestID, ""),
#                         function(x){
#                           x[2]
#                         })    
# totalLen_data$nestTYPE<-paste0(Queencharacter, Numbercharacter)
# ## summarize data by nest and also by camID
# data_sum<- totalLen_data %>% select(camID, nestID, nestTYPE) %>% arrange(nestID, camID)
# 
# sumsTOTAL<-datasum %>% group_by(nestID, camID) %>% summarise(len=sum())
# sumsTYPE<-datasum %>% group_by(nestTYPE, camID) %>% summarise(len=sum())
# 
# data_sum
# sumsTOTAL
# sumsTYPE









## create empty dataframe to put length into
camDur <- data.frame(nestID = NA,
                     forLen = NA,
                     nestLen = NA,
                     totalLen = NA)

## for each unique nest, subset the data to look at one nest at a time. then split out foraging and nest videos
for (i in 1:length(unique(totalLen_data$nestID))) {
  sub_data <- subset(totalLen_data, nestID == unique(totalLen_data$nestID)[i]) # subset to look at a single nest
  for_data <- subset(sub_data, sub_data$camID == "for")                 # subset foraging video only into for_data
  nest_data <- subset(sub_data, sub_data$camID == "nest")               # subset nest video only into nest_data
  forSum <- sum(for_data$totalLen)                                      # sum the video duration of all foraging videos
  totNestSum <- sum(nest_data$totalLen)                                 # sum the video duration of all nest videos
  camDur <- rbind(camDur, c(sub_data$nestID[1], forSum, totNestSum, camSum)) # add the sum totals to the camDur df
}
## remove NA row initially created
camDur <- camDur[2:nrow(camDur),]

## count to make sure all colonies are accounted for
print(paste("There are", nrow(camDur), "colonies accounted for in the camDur dataframe out of", nrow(master_data), "master colonies.", sep = " "))

## make columns numeric so i can calculate ratio in next step
camDur$totalLen <- as.numeric(camDur$totalLen)
camDur$forLen <- as.numeric(camDur$forLen)
camDur$nestLen <- as.numeric(camDur$nestLen)
camDur$nestID <- as.character(camDur$nestID)

## make new column with the ratio of foraging to nest video length. should be ~12 for each colony. if it's not, need to watch more videos
camDur$FNratio <- NA
for (i in 1:nrow(camDur)) {
  camDur$FNratio[i] <- camDur$forLen[i] / camDur$nestLen[i]
}

##Save dataframe as .csv so it can be used in other downstrea analyses 
write.csv(camDur, "camDur.csv")

## check to see how much video was watched for each nest and for each treatment
## must be equal + ratio must be 1 to compare
camDur
camDur <- camDur[order(camDur$nestID),]

## graph total duration of video watched for each colony
##look at data we have so far based on each colony 

## Make a new column for nest type ie. NT or QT 
Queencharacter<-sapply(strsplit(camDur$nestID, ""), 
                          function(x){
                            x[1]
                          })
Numbercharacter<-sapply(strsplit(camDur$nestID, ""),
                        function(x){
                          x[2]
                        })    
                          
camDur$nestTYPE<-paste0(Queencharacter, Numbercharacter)

sumsTYPE<-camDur %>% group_by(nestTYPE)
ggplot(camDur, aes(x=nestID, y=forLen, fill = nestTYPE)) +
  geom_bar(stat="identity")+theme(axis.text.x=element_text(angle=90))

ggplot(camDur, aes(x=nestID, y=nestLen, fill = nestTYPE)) +
  geom_bar(stat="identity")+theme(axis.text.x=element_text(angle=90))

## look at data we have so far based on each type of colony 

ggplot(sumsTYPE, aes(x=nestTYPE, y=forLen, fill = nestTYPE)) +
  geom_bar(stat="identity")+theme(axis.text.x=element_text(angle=90))

ggplot(sumsTYPE, aes(x=nestTYPE, y=nestLen, fill = nestTYPE)) +
  geom_bar(stat="identity")+theme(axis.text.x=element_text(angle=90))

## print number of seconds and hours of video watched

## summary of all videos
allNestH <- sum(camDur$nestLen)/60/60
allForH <- sum(camDur$forLen)/60/60
allVideosH <- sum(camDur$totalLen)/60/60
avgNestH <- mean(camDur$nestLen)/60/60
avgForH <- mean(camDur$forLen)/60/60
avgTotalH <- mean(camDur$totalLen)/60

# summary by group
avgNFnestH <- mean(camDur$nestLen[camDur$nestTYPE == "NF"])/60/60
avgNTnestH <- mean(camDur$nestLen[camDur$nestTYPE == "NT"])/60/60
avgQFnestH <- mean(camDur$nestLen[camDur$nestTYPE == "QF"])/60/60
avgQTnestH <- mean(camDur$nestLen[camDur$nestTYPE == "QT"])/60/60

avgNFforH <- mean(camDur$forLen[camDur$nestTYPE == "NF"])/60/60
avgNTforH <- mean(camDur$forLen[camDur$nestTYPE == "NT"])/60/60
avgQFforH <- mean(camDur$forLen[camDur$nestTYPE == "QF"])/60/60
avgQTforH <- mean(camDur$forLen[camDur$nestTYPE == "QT"])/60/60

# print summaries
print(paste("We watched", round(allNestH, digits = 1), "hours of NEST videos overall, which is an average of", round(avgNestH, digits = 1), "hours per colony", sep = " "))
print(paste("We watched", round(allForH, digits = 1), "hours of FORAGING videos overall, which is an average of", round(avgForH, digits = 1), "hours per colony", sep = " "))
print(paste("We watched", round(allVideosH, digits = 1), "hours of ALL videos overall, which is an average of", round(avgTotalH, digits = 1), "hours per colony", sep = " "))

print(paste("NF COLONIES: we watched an average of", round(avgNFnestH, digits = 1), "hours of NEST and", round(avgNFforH, digits = 1), "hours of FOR", sep = " "))
print(paste("NT COLONIES: we watched an average of", round(avgNTnestH, digits = 1), "hours of NEST and", round(avgNTforH, digits = 1), "hours of FOR", sep = " "))
print(paste("QF COLONIES: we watched an average of", round(avgQFnestH, digits = 1), "hours of NEST and", round(avgQFforH, digits = 1), "hours of FOR", sep = " "))
print(paste("QT COLONIES: we watched an average of", round(avgQTnestH, digits = 1), "hours of NEST and", round(avgQTforH, digits = 1), "hours of FOR", sep = " "))

# summary by colony 
for (i in 1:nrow(camDur)) {
  print(paste(camDur$nestID[i], ": we watched a total of", round(camDur$nestLen[i]/60/60, digits = 1), "hours of NEST and", round(camDur$forLen[i]/60/60, digits = 1), "hours of FOR", sep = " "))
}


```







