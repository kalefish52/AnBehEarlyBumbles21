---
title: "nest development"
output: PDF
---

### load packages
```{r}
library(tidyverse)
library(ggplot2)
library(car)
library(ggpubr)
library(MuMIn)
library(MASS)
```

## load data
```{r}
# wd must be set to where this doc lives (Manuscript_analyses)

# nest data
nest_data <- read.csv("../Data/NestDissections.csv", header = TRUE)

# wing length data
wing_data <- read.csv("../Data/MaleWingMeasurements.csv", header = TRUE)
```

## clean and reformat data
```{r}
# remove bad data
nest_data <- nest_data[!startsWith(nest_data$nestID, "QA"),]  # remove QA groups
nest_data <- nest_data[!nest_data$nestID == "QF01",]          # QF01 was frozen and males eclosed, but all adults died
nest_data <- nest_data[!nest_data$nestID == "QF08",]          # missing workers
nest_data <- nest_data[!nest_data$nestID == "NT07",]          # missing workers

wing_data <- wing_data[!startsWith(wing_data$nestID, "QA"),]  # remove QA groups
wing_data <- wing_data[!wing_data$nestID == "QF01",]          # QF01 was frozen and males eclosed, but all adults died
wing_data <- wing_data[!wing_data$nestID == "QF08",]          # missing workers
wing_data <- wing_data[!wing_data$nestID == "NT07",]          # missing workers

# add bee identifier to wing_data
wing_data$bee <- 1:nrow(wing_data)

# add nestTYPE column to both datasets, add columns for number of workers, number of queens, and number of bees
qChar <- sapply(strsplit(nest_data$nestID, ""), function(x) {x[1]} )
wChar <- sapply(strsplit(nest_data$nestID, ""), function(x) {x[2]} )
nest_data$nestTYPE <- paste0(qChar, wChar)
nest_data$nWorkers <- wChar
nest_data$nWorkers[nest_data$nWorkers == "F"] <- 5
nest_data$nWorkers[nest_data$nWorkers == "T"] <- 3
nest_data$nQueen <- qChar
nest_data$nQueen[nest_data$nQueen == "N"] <- 0
nest_data$nQueen[nest_data$nQueen == "Q"] <- 1
nest_data$nWorkers <- as.numeric(nest_data$nWorkers)
nest_data$nQueen <- as.numeric(nest_data$nQueen)
nest_data$nBees <- nest_data$nWorkers + nest_data$nQueen
nest_data

qChar <- sapply(strsplit(wing_data$nestID, ""), function(x) {x[1]} )
wChar <- sapply(strsplit(wing_data$nestID, ""), function(x) {x[2]} )
wing_data$nestTYPE <- paste0(qChar, wChar)
wing_data$nWorkers <- wChar
wing_data$nWorkers[wing_data$nWorkers == "F"] <- 5
wing_data$nWorkers[wing_data$nWorkers == "T"] <- 3
wing_data$nQueen <- qChar
wing_data$nQueen[wing_data$nQueen == "N"] <- 0
wing_data$nQueen[wing_data$nQueen == "Q"] <- 1
wing_data$nWorkers <- as.numeric(wing_data$nWorkers)
wing_data$nQueen <- as.numeric(wing_data$nQueen)
wing_data$nBees <- wing_data$nWorkers + wing_data$nQueen
wing_data

# sum total number of brood in nest_data
nest_data$blackLarvae <- as.numeric(nest_data$blackLarvae)
nest_data$males <- as.numeric(nest_data$males)
nest_data$nBrood <- rowSums(nest_data[, c("e1", "e2", "e3", "e4", "e5", "e6", "e7", "e8", "e9", "e10", "e11", "e12", 
                                          "larvae", "blackLarvae", "pupae", "prePupae", "males")], na.rm = TRUE)

# sum total number of larvae in nest_data
nest_data$totLarvae <- rowSums(nest_data[, c("larvae", "blackLarvae", "prePupae")], na.rm = TRUE)

# sum total number of eggs in nest_data
nest_data$eggs <- rowSums(nest_data[, c("e1", "e2", "e3", "e4", "e5", "e6", "e7", "e8", "e9", "e10", "e11", "e12")], na.rm = TRUE)
```

# mixed models
```{r}
# response variables = # brood total, # brood split out by type, male size
# fixed effects = nest type (or bee number + queen presence)
# random effects = worker natal colony (include queen natal colony?)
```


### male size: NS
data is mostly normal
```{r}
# visualize the distribution
ggdensity(wing_data$beeAvg)
# normal 
qqp(wing_data$beeAvg, "norm")
# # lnorm means lognormal
# qqp(wing_data$beeAvg, "lnorm")
# # gamma must be positive numbers
# gamma <- fitdistr(wing_data$beeAvg, "gamma")
# qqp(wing_data$beeAvg, "gamma", shape = gamma$estimate[[1]], rate = gamma$estimate[[2]])

# define model
maleSize1 <- lm(beeAvg ~ nestTYPE, data = wing_data)
maleSize2 <- lm(beeAvg ~ nQueen + nBees, data = wing_data)

# check for significance
anova(maleSize1)
anova(maleSize2)
```

### total number of brood: NS
data is mostly normal
```{r}
# visualize the distribution
ggdensity(nest_data$nBrood)
# normal 
qqp(nest_data$nBrood, "norm")
# # lnorm means lognormal
# qqp(nest_data$nBrood, "lnorm")
# # gamma must be positive numbers
# gamma <- fitdistr(nest_data$nBrood, "gamma")
# qqp(nest_data$nBrood, "gamma", shape = gamma$estimate[[1]], rate = gamma$estimate[[2]])

# define model
nBrood1 <- lm(nBrood ~ nestTYPE, data = nest_data)
nBrood2 <- lm(nBrood ~ nQueen + nBees, data = nest_data)

# check for significance
anova(nBrood1)
anova(nBrood2)
```

### number of males: NS
data is mostly normal
```{r}
# visualize the distribution
ggdensity(nest_data$males)
# normal 
qqp(nest_data$males, "norm")
# lnorm means lognormal
qqp(nest_data$males, "lnorm")
# gamma must be positive numbers
gamma <- fitdistr(nest_data$males, "gamma")
qqp(nest_data$males, "gamma", shape = gamma$estimate[[1]], rate = gamma$estimate[[2]])

# define model
nMales1 <- lm(males ~ nestTYPE, data = nest_data)
nMales2 <- lm(males ~ nQueen + nBees, data = nest_data)

# check for significance
anova(nMales1)
anova(nMales2)
```


### number of pupae: nBees p < 0.05
data is mostly normal
```{r}
# visualize the distribution
ggdensity(nest_data$pupae)
# normal 
qqp(nest_data$pupae, "norm")
# # lnorm means lognormal
# qqp(nest_data$pupae, "lnorm")
# # gamma must be positive numbers
# gamma <- fitdistr(nest_data$pupae, "gamma")
# qqp(nest_data$pupae, "gamma", shape = gamma$estimate[[1]], rate = gamma$estimate[[2]])

# define model
nPupae1 <- lm(pupae ~ nestTYPE, data = nest_data)
nPupae2 <- lm(pupae ~ nQueen + nBees, data = nest_data)

# check for significance
anova(nPupae1)
anova(nPupae2)
```

### total number of larvae + prepupae: nestTYPE p < 0.05
data is mostly normal
```{r}
# visualize the distribution
ggdensity(nest_data$totLarvae)
# normal 
qqp(nest_data$totLarvae, "norm")
# # lnorm means lognormal
# qqp(nest_data$totLarvae, "lnorm")
# # gamma must be positive numbers
# gamma <- fitdistr(nest_data$totLarvae, "gamma")
# qqp(nest_data$totLarvae, "gamma", shape = gamma$estimate[[1]], rate = gamma$estimate[[2]])

# define model
totLarv1 <- lm(totLarvae ~ nestTYPE, data = nest_data)
totLarv2 <- lm(totLarvae ~ nQueen + nBees, data = nest_data)

# check for significance
anova(totLarv1)
anova(totLarv2)
```

### number of eggs: NS
data is mostly normal
```{r}
# visualize the distribution
ggdensity(nest_data$eggs)
# normal 
qqp(nest_data$eggs, "norm")
# # lnorm means lognormal
# qqp(nest_data$eggs, "lnorm")
# # gamma must be positive numbers
# gamma <- fitdistr(nest_data$eggs, "gamma")
# qqp(nest_data$eggs, "gamma", shape = gamma$estimate[[1]], rate = gamma$estimate[[2]])

# define model
egg1 <- lm(eggs ~ nestTYPE, data = nest_data)
egg2 <- lm(eggs ~ nQueen + nBees, data = nest_data)

# check for significance
anova(egg1)
anova(egg2)
```
#####
##########
######################
##########
#####
#####
##########
######################
##########
#####
#####
##########
######################
##########
#####
#####
##########
######################
##########
#####
#####
##########
######################
##########
#####
#####
##########
######################
##########
#####
#####
##########
######################
##########
#####
#####
##########
######################
##########
#####


## Analyses I'm trying to turn into a function
```{r}
## kruskal wallis
df <- subset(nest_data, !is.na(Brood))
df <- subset(df, !is.na(Treatment))
kruskal.test(Brood ~ Treatment, data = df)

## dunn test
dunnTest(Brood ~ Treatment, data = df, method="bh")

## summary stats
## mean, standard deviation and standard error of the meand
df <- subset(nest_data, !is.na(Brood))
df <- subset(df, !is.na(Treatment))
df$Treatment <- factor(df$Treatment, levels = c("QA", "QT", "QF"))

summ <- ddply(df, c("Treatment"), summarise,
      mean = mean(Brood), sd = sd(Brood),
      sem = sd(Brood)/sqrt(length(Brood)))
summ

## make barplot with error bars
p <- ggplot(summ, aes(x = Treatment, 
                      y = mean, 
                      fill = Treatment,
                      ymin = mean - sem,
                      ymax = mean + sem)) +
  geom_bar(position = position_dodge(),
           stat="identity",
           width = 0.5) +
  geom_errorbar(position=position_dodge(0.5), 
                width=0.1) +
  theme(text = element_text(size=20)) +
  theme(legend.position="none") +
  labs(x = "Social Treatment", 
       y = "Number of brood items") +
  scale_x_discrete(labels=c("QA" = "Q0", 
                            "QT" = "Q3",
                            "QF" = "Q5"))
ggsave("brood.jpeg", path = "../figures")

## function to run kruskal wallis. removes NA values 
# ***this isn't working. now sure why. error: object 'Brood' not found
kw <- function(df, dep_var, ind_var) {
  df1 <- subset(df, !is.na(dep_var))
  df1 <- subset(df1, !is.na(ind_var))
  kruskal.test(dep_var ~ ind_var, data = df1)
}
kw(df = nest_data, dep_var = Brood, ind_var = Treatement)

```

### Brood - *QA-QF p < 0.01
```{r}
## repeat for other measurements
## Brood -- *QA-QF p < 0.01

## summary stats
ddply(nest_data, c("Treatment"), summarise,
      mean = mean(Brood), sd = sd(Brood),
      sem = sd(Brood)/sqrt(length(Brood)))
## kruskal wallis
df <- subset(nest_data, !is.na(Brood))
df <- subset(df, !is.na(Treatment))
kruskal.test(Brood ~ Treatment, data = df)
## dunn test
dunnTest(Brood ~ Treatment, data = df, method="bh")

## make plot
p <- ggplot(summ, aes(x = Treatment, 
                      y = mean, 
                      fill = Treatment,
                      ymin = mean - sem,
                      ymax = mean + sem)) +
  geom_bar(position = position_dodge(),
           stat="identity",
           width = 0.5) +
  geom_errorbar(position=position_dodge(0.5), 
                width=0.1) +
  theme(text = element_text(size=20)) +
  theme(legend.position="none") +
  labs(x = "Social Treatment", 
       y = "Number of brood items") +
  scale_x_discrete(labels=c("QA" = "Q0", 
                            "QT" = "Q3",
                            "QF" = "Q5"))
ggsave("brood.jpeg", path = "../figures")
p

```
### Eggs - NS
```{r}
## repeat for other measurements
## eggs -- ns

## summary stats
df$Treatment <- factor(df$Treatment, levels = c("QA", "QT", "QF"))
summ <- ddply(df, c("Treatment"), summarise,
      mean = mean(Eggs), sd = sd(Eggs),
      sem = sd(Eggs)/sqrt(length(Eggs)))
## kruskal wallis
df <- subset(nest_data, !is.na(Eggs))
df <- subset(df, !is.na(Treatment))
kruskal.test(Eggs ~ Treatment, data = df)
## dunn test
dunnTest(Eggs ~ Treatment, data = df, method="bh")

## make plot
p <- ggplot(summ, aes(x = Treatment, 
                      y = mean, 
                      fill = Treatment,
                      ymin = mean - sem,
                      ymax = mean + sem)) +
  geom_bar(position = position_dodge(),
           stat="identity",
           width = 0.5) +
  geom_errorbar(position=position_dodge(0.5), 
                width=0.1) +
  theme(text = element_text(size=20)) +
  theme(legend.position="none") +
  labs(x = "Social Treatment", 
       y = "Number of eggs") +
  scale_x_discrete(labels=c("QA" = "Q0", 
                            "QT" = "Q3",
                            "QF" = "Q5"))
p

#ggsave("eggs.jpeg", path = "../figures")
```
### Healthy Larvae - NS
```{r}
## repeat for other measurements
## HealthyLarv - ns

## summary stats
df$Treatment <- factor(df$Treatment, levels = c("QA", "QT", "QF"))
summ <- ddply(df, c("Treatment"), summarise,
      mean = mean(HealthyLarv), sd = sd(HealthyLarv),
      sem = sd(HealthyLarv)/sqrt(length(HealthyLarv)))
## kruskal wallis
df <- subset(nest_data, !is.na(HealthyLarv))
df <- subset(df, !is.na(Treatment))
kruskal.test(HealthyLarv ~ Treatment, data = df)
## dunn test
dunnTest(HealthyLarv ~ Treatment, data = df, method="bh")

## make plot
p <- ggplot(summ, aes(x = Treatment, 
                      y = mean, 
                      fill = Treatment,
                      ymin = mean - sem,
                      ymax = mean + sem)) +
  geom_bar(position = position_dodge(),
           stat="identity",
           width = 0.5) +
  geom_errorbar(position=position_dodge(0.5), 
                width=0.1) +
  theme(text = element_text(size=20)) +
  theme(legend.position="none") +
  labs(x = "Social Treatment", 
       y = "Number of larvae") +
  scale_x_discrete(labels=c("QA" = "Q0", 
                            "QT" = "Q3",
                            "QF" = "Q5"))
p

#ggsave("larvae.jpeg", path = "../figures")
```
### Pupae - *QA-QF p < 0.001
```{r}
## repeat for other measurements
## Pupae - *QA-QF p < 0.001

## summary stats
df <- subset(nest_data, !is.na(Pupae))
df <- subset(df, !is.na(Treatment))
df$Treatment <- factor(df$Treatment, levels = c("QA", "QT", "QF"))
summ <- ddply(df, c("Treatment"), summarise,
      mean = mean(Pupae), sd = sd(Pupae),
      sem = sd(Pupae)/sqrt(length(Pupae)))
summ
## kruskal wallis
df <- subset(nest_data, !is.na(Pupae))
df <- subset(df, !is.na(Treatment))
kruskal.test(Pupae ~ Treatment, data = df)
## dunn test
dunnTest(Pupae ~ Treatment, data = df, method="bh")

## make plot
p <- ggplot(summ, aes(x = Treatment, 
                      y = mean, 
                      fill = Treatment,
                      ymin = mean - sem,
                      ymax = mean + sem)) +
  geom_bar(position = position_dodge(),
           stat="identity",
           width = 0.5) +
  geom_errorbar(position=position_dodge(0.5), 
                width=0.1) +
  theme(text = element_text(size=20)) +
  theme(legend.position="none") +
  labs(x = "Social Treatment", 
       y = "Number of pupae") +
  scale_x_discrete(labels=c("QA" = "Q0", 
                            "QT" = "Q3",
                            "QF" = "Q5"))
p

#ggsave("pupae.jpeg", path = "../figures")
```
### Adult Males - NS
```{r}
## repeat for other measurements
## AdultMales -- ns

## summary stats
df <- subset(nest_data, !is.na(AdultMales))
ddply(df, c("Treatment"), summarise,
      mean = mean(AdultMales), sd = sd(AdultMales),
      sem = sd(AdultMales)/sqrt(length(AdultMales)))
## kruskal wallis
df <- subset(nest_data, !is.na(AdultMales))
df <- subset(df, !is.na(Treatment))
kruskal.test(AdultMales ~ Treatment, data = df)
## dunn test
dunnTest(AdultMales ~ Treatment, data = df, method="bh")

## make plot
df$Treatment <- factor(df$Treatment, levels = c("QA", "QT", "QF"))
p <- ggplot(df, aes(x = Treatment, y = AdultMales, fill = Treatment)) +
  geom_boxplot() +
  #geom_bar(aes(x = Treatment, y = mean)) +
  #geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem), width=.2, position=position_dodge(.9)) +
  theme(text = element_text(size=20)) +
  theme(legend.position = "none") +
  labs(x = "Social Treatment", y = "Number of Adult Males") +
  scale_x_discrete(labels=c("QA" = "Q0", "QT" = "Q3", "QF" = "Q5"))
p
```

# Master Data
```{r}
## Load different datasheet
lay_data <- read.csv("../data/Master.csv", header = TRUE)

## Remove queenless groups
lay_data <- subset(lay_data, lay_data$Treatment != "NF" & lay_data$Treatment != "NT")
head(lay_data)
```
### Days to Lay Eggs
```{r}
## kruskal wallis
df <- subset(lay_data, !is.na(DaysToEggs))
df <- subset(df, !is.na(Treatment))
kruskal.test(DaysToEggs ~ Treatment, data = df)
## dunn test
dunnTest(DaysToEggs ~ Treatment, data = df, method="bh")

## summary stats
## mean, standard deviation and standard error of the meand
df <- subset(lay_data, !is.na(DaysToEggs))
df <- subset(df, !is.na(Treatment))
df$Treatment <- factor(df$Treatment, levels = c("QA", "QT", "QF"))

summ <- ddply(df, c("Treatment"), summarise,
      mean = mean(DaysToEggs), sd = sd(DaysToEggs),
      sem = sd(DaysToEggs)/sqrt(length(DaysToEggs)))
summ

## make barplot with error bars
ggplot(summ, aes(x = Treatment, 
                      y = mean, 
                      fill = Treatment,
                      ymin = mean - sem,
                      ymax = mean + sem)) +
  geom_bar(position = position_dodge(),
           stat="identity",
           width = 0.5) +
  geom_errorbar(position=position_dodge(0.5), 
                width=0.1) +
  theme(text = element_text(size=20)) +
  theme(legend.position="none") +
  labs(x = "Social Treatment", 
       y = "Time Until First Eggs Laid (days)") +
  scale_x_discrete(labels=c("QA" = "Q0", 
                            "QT" = "Q3",
                            "QF" = "Q5"))


ggsave("daysToEggs.jpeg", path = "../figures")
```
### Eggs to Eclosion Time
```{r}
## summary stats
df <- subset(lay_data, !is.na(EggsToEclosion))
ddply(df, c("Treatment"), summarise,
      mean = mean(EggsToEclosion), sd = sd(EggsToEclosion),
      sem = sd(EggsToEclosion)/sqrt(length(EggsToEclosion)))
## kruskal wallis
df <- subset(lay_data, !is.na(EggsToEclosion))
df <- subset(df, !is.na(Treatment))
kruskal.test(EggsToEclosion ~ Treatment, data = df)
## dunn test
dunnTest(EggsToEclosion ~ Treatment, data = df, method="bh")

## make plot
df$Treatment <- factor(df$Treatment, levels = c("QA", "QT", "QF"))
p <- ggplot(df, aes(x = Treatment, y = EggsToEclosion, fill = Treatment)) +
  geom_boxplot() +
  #geom_bar(aes(x = Treatment, y = mean)) +
  #geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem), width=.2, position=position_dodge(.9)) +
  theme(text = element_text(size=20)) +
  theme(legend.position = "none") +
  labs(x = "Social Treatment", y = "Time from Eggs to Eclosion (days)") +
  scale_x_discrete(labels=c("QA" = "Q0", "QT" = "Q3", "QF" = "Q5"))
p
```