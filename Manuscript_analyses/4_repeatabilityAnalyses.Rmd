---
title: "Repeatability Analysis"
output: pdf_document
fig.width: 6
fig.height: 15
---
#Need to run after Shannon Bees 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load packages
```{r}
library(tidyverse)
library(dplyr)
library(plyr)
library(ggplot2)
library(cluster) # clustering algorithms
library(factoextra)
library(vegan) 
library(lme4)
library(plotly)
library(ggpubr)
library(car)
library(MASS)
library(MuMIn)
library(lsmeans)
```

# load data
```{r}
rptdata<-read.csv("../Data/filtData/count_time.csv") %>% select(nestID, nestTYPE, beeID, caste, timepoint, nectarforaging, feedsbrood, pollenforaging)
head(rptdata)

obsdata<-read.csv("../Data/filtData/obs_time.csv")%>% select(camID, nestID, dateID, hourID, timepoint)

%>% distinct(camID,  nestID, dateID, hourID, timepoint)

obsdata %>% filter(nestID=="QT15")

unfilteredobs<-read.csv("../Data/obs_data.csv")
unfilteredobs %>% filter(nestID=="NF03")
#How many observations (nest and for) did we do for each nest? 
obsdatascale<-obsdata %>% mutate(count=1) %>% group_by(nestID, camID) %>%mutate(obsnum=sum(count)) %>% select(!c(count, dateID, hourID)) %>% unique()
obsdatascale 
obsdata%>% filter(nestID=="QT15")
fors<-obsdatascale %>% filter(camID=="for")
fors
full_join(rptdata, fors, by="nestID") %>% arrange(nestID) %>% select(nestID, beeID, timepoint, camID, obsnum)


#How many observations do we have? (all, early, late)
print(paste("There are", nrow(rptdata), "rows"))
Earlies<-rptdata %>% filter(timepoint=="early") 
print(paste("There are", nrow(Earlies), "early rows"))
Laties<-rptdata%>% filter(timepoint=="late") 
print(paste("There are", nrow(Laties), "late rows"))

```
# Repeatability measurements and interpretation instructions 
https://cran.r-project.org/web/packages/rptR/vignettes/rptR.html
If 95% confidence intervals of random effect does not reach 0, this suggests that the behavior is repeatable 
Individuals=grouping factor in our case 
R^2 quantifies the proportion of variance explained by fixed effects 
R=0 no variation is explained by the fixed effect 
Adjusted repeatability: controls for fixed effects - any variance that is explained by the fixed effect is excluded from the denominator 
```{r}
library(rptR)
```

#Alternative to rptR 
rptR is not working because the package supports a limited type of data distributions
Instead, we will try to use the theory behind this package but with a more versatile package
```{r}
library(lme4)
head(rptdata)

lmer_nectar<-glmer(nectarforaging~timepoint+(1|beeID), data=rptdata, family = binomial(link = "logit"))
plot(lmer_nectar)

hist(residuals(lmer_nectar))
summary(lmer_nectar)

rep_nectar<-tidy(lmer_nectar, effects="ran_pars", scales="vcov") %>% 
  select(group, estimate) %>% 
  spread(group, estimate) %>% 
  mutate(repeatability=ID/(ID+Residual))
```

#Repeatability analyses for scaled proportions - poisson data type

#Repeatability analyses for proportions with no scaling - proportion data type
```{r}
#Repeatability proportion brood feeding 
hist(rpt_prop$propfb) # proportion distribution
reppfb<- rpt(propfb ~ timepoint+(1|beeID)+(1|nestID),
            grname = c("beeID", "nestID"), data = rpt_prop, 
            datatype = "Proportion", nboot = 1000, npermut = 0)
summary(reppfb)
print(reppfb)
plot(reppfb, cex.main = 1)

#Repeatability proportion nectar foraging
reppnf<- rpt(propn ~ timepoint+(1|beeID)+(1|nestID),
            grname = c("beeID", "nestID"), data = rpt_prop, 
            datatype = "Proportion", nboot = 1000, npermut = 0)
summary(reppnf)
print(reppnf)
plot(reppnf, cex.main = 1)

#Repeatability proportion pollen foraging 
reppf<- rpt(propp ~ timepoint+(1|beeID)+(1|nestID),
            grname = c("beeID", "nestID"), data = rpt_prop, 
            datatype = "Proportion", nboot = 1000, npermut = 0)
summary(reppf)
print(reppf)
plot(reppf, cex.main = 1)

#Repeatability proportion total foraging
reppf<- rpt(propp ~ timepoint+(1|beeID)+(1|nestID),
            grname = c("beeID", "nestID"), data = rpt_prop, 
            datatype = "Proportion", nboot = 1000, npermut = 0)
summary(reppf)
print(reppf)
plot(reppf, cex.main = 1)
```
# Try with MCMM package as in Jolles et al.  2017
```{r}

library(MCMCglmm)
library(rptR)





```













































