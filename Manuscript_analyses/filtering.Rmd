---
title: "filtering"
author: "ES"
date: "6/22/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load packages
```{r}
library(ggplot2)
library(tidyr)
library(dplyr)
library(plyr)
```

# load data
```{r}
counts_data <- read.csv("../Data/countsanalysis.csv")
counts_data
```

# look at the number of events of each behavior per nest
# filter out nests with < 3 observations each of brood feeding and foraging behaviors
counts_filt = nests with at least 3 observations of each behavior
*can be used in all analyses in which timepoints are pooled
```{r}
# first combine pollen and nectar foraging into a single value
counts_data$allforaging <- counts_data$nectarforaging + counts_data$pollenforaging

# gather all behaviors into a single column
counts_gathered <- counts_data %>% gather("feedsbrood", "allforaging", key = "behav", value = "count")
counts_gathered

# sumNest <- counts_gathered %>% group_by(nestID, behav)
# 
# ggplot(sumNest, aes(x = nestID, y = count, fill = behav)) +
#   geom_bar(stat ="identity") + 
#   theme(axis.text.x = element_text(angle = 90), legend.position = "top")

# summarize the total behaviors observed across all individuals
statsBehav <- ddply(counts_gathered, 
                c("behav"), 
                summarise,
                nObs = sum(count),
                mean = mean(count), 
                sd = sd(count),
                sem = sd(count)/sqrt(length(count)))
statsBehav

PstatsBehav <- ggplot(statsBehav, aes(x = behav, y = nObs, fill = behav)) + geom_bar(stat = "identity")
PstatsBehav

# summarize behaviors observed for each nest
statsNest <- ddply(counts_gathered, 
                c("nestID", "behav"), 
                summarise,
                nObs = sum(count),
                mean = mean(count), 
                sd = sd(count),
                sem = sd(count)/sqrt(length(count)))
statsNest
PstatsNest <- ggplot(statsNest, aes(x = nestID, y = nObs, fill = behav)) + 
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 90), legend.position = "top")
PstatsNest

# remove nests with fewer than 3 observations each of foraging and brood feeding
# look at which nests need to be removed
rmObs <- statsNest[statsNest$nObs < 3,]
rmObs
rmNests <- unique(rmObs$nestID)
print(paste(length(rmNests), "nests were filtered out of the data because they have fewer than 3 instances each of brood feeding or foraging recorded", sep = " "))
rmNests
nestCounts_filt <- counts_data %>% filter(!nestID %in% rmNests)
nestCounts_filt
unique(counts_filt$nestID)
write.csv(nestCounts_filt, "../Data/tempData/nestCounts_filt.csv")

# # remove nests with fewer than 5 observations of foraging or brood feeding combined
# combObs <- statsNest[, c("nestID", "behav", "nObs")]
# combObs <- combObs %>%
#   pivot_wider(id_cols = c("nestID"), 
#               names_from = behav, 
#               values_from = nObs)
# combObs$totObs <- combObs$allforaging + combObs$feedsbrood
# combObs
# write.csv(combObs, "../Data/totalObs.csv")
# 
# # look at which nests need to be removed
# rmObs <- combObs[combObs$totObs < 10,]
# rmObs
# print(paste("the following", length(rmObs), "nests need to be removed from the pooled time data because they have fewer than 5 instances of combined brood feeding and foraging recorded:", rmObs, sep = " "))

# counts_filt <- counts_data %>% filter(!nestID %in% rmNests)
# counts_filt
# write.csv(counts_filt, "../Data/tempData/counts_filt.csv")
```

# look at number of behaviors per bee
# filter out bees with < 3 behaviors
```{r}
counts_data
beeCounts_filt <- counts_data[counts_data$nBehavs >= 3,]
beeCounts_filt <- beeCounts_filt[beeCounts_filt$beeID != "unknown",]
beeCounts_filt
write.csv(beeCounts_filt, "../Data/tempData/beeCounts_filt.csv")

print(paste(nrow(beeCounts_filt), "out of", nrow(counts_data), "identified bees have at least 3 recorded observations.", sep = " "))
print(paste(nrow(counts_data)-nrow(beeCounts_filt), "bees were filtered out of the data because they have fewer than 3 observations or are unidentified.", sep = " "))
```

# subset unknown workers from filtered nests
```{r}
obs_data <- read.csv("../Data/obs_data")
cleaned_obs <- subset(obs_data, (nestID %in% nestCounts_filt$nestID))

unknown_workers <- cleaned_obs[cleaned_obs$beeID == "unknown",]
write.csv(unknown_workers, "../Data/tempData/unknownWorkers.csv")
```


# do the same filtering for early and late timepoints individually
counts_time = count data with at least 3 observations of each behavior at both early and late timepoints
*can be used in all analyses that compare across time
```{r}
# summarize behaviors observed for each nest at early and late timepoints
statsNestTime <- ddply(counts_gathered, 
                c("nestID", "behav", "timepoint"), 
                summarise,
                nObs = sum(count),
                mean = mean(count), 
                sd = sd(count),
                sem = sd(count)/sqrt(length(count)))

# summarize early timepoint
statsNestEarly <- statsNestTime[statsNestTime$timepoint == "early",]
PstatsNestEarly <- ggplot(statsNestEarly, aes(x = nestID, y = nObs, fill = behav)) + 
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 90), legend.position = "top")
PstatsNestEarly
# remove nests wither fewer than 3 observations per behavior at early timepoint
rmObsEarly <- statsNestEarly[statsNestEarly$nObs < 3,]
rmObsEarly
rmNestsEarly <- unique(rmObsEarly$nestID)
print(paste(length(rmNestsEarly), "nests need to be removed from the early timepoint data because they have fewer than 3 instances of brood feeding or foraging recorded"))
rmNestsEarly
goodNestsEarly <- counts_data %>% filter(!nestID %in% rmNestsEarly)
write.csv(goodNestsEarly, "../Data/tempData/nestEarlyCounts_filt.csv")
unique(goodNestsEarly$nestID)

# summarize late timepoint
statsNestLate <- statsNestTime[statsNestTime$timepoint == "late",]
PstatsNestLate <- ggplot(statsNestLate, aes(x = nestID, y = nObs, fill = behav)) + 
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 90), legend.position = "top")
PstatsNestLate
# remove nests wither fewer than 3 observations per behavior at late timepoint
rmObsLate <- statsNestLate[statsNestLate$nObs < 3,]
rmObsLate
rmNestsLate <- unique(rmObsLate$nestID)
print(paste(length(rmNestsLate), "nests need to be removed from the late timepoint data because they have fewer than 3 instances of brood feeding or foraging recorded"))
rmNestsLate
goodNestsLate <- counts_data %>% filter(!nestID %in% rmNestsLate)
goodNestsLate
write.csv(goodNestsLate, "../Data/tempData/nestLateCounts_filt.csv")
unique(goodNestsLate$nestID)

# dataframe that can be used to compare across timepoints (at least 3 observations of each behavior in both early and late timepoints)
counts_time <- counts_data %>% filter(!nestID %in% rmNestsEarly) %>% filter(!nestID %in% rmNestsLate)
counts_time
unique(counts_time$nestID)
write.csv(counts_time, "../Data/tempData/nestEarlyANDLateCounts_filt.csv")
```